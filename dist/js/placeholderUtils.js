!function(e){var t={};function n(o){if(t[o])return t[o].exports;var l=t[o]={i:o,l:!1,exports:{}};return e[o].call(l.exports,l,l.exports,n),l.l=!0,l.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var l in e)n.d(o,l,function(t){return e[t]}.bind(null,l));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}({9:function(e,t,n){"use strict";n.r(t),n.d(t,"Placeholder",function(){return o}),n.d(t,"testPlaceholderPresence",function(){return r}),n.d(t,"updatePlaceholderState",function(){return c}),n.d(t,"resetPlaceholderState",function(){return l}),n.d(t,"insertSnippetInContentEditableNode",function(){return a}),n.d(t,"prepareSnippetBody",function(){return i}),n.d(t,"handlePlainTextTabNavigation",function(){return s}),n.d(t,"handleRichTextTabNavigation",function(){return u}),n.d(t,"navigateToNextPlaceholder",function(){return p});let o={mode:!1,fromIndex:-1,toIndex:-1,selectionLength:0,justSelected:!1,node:null,isCENode:!1,array:[],currentIndex:-1};function l(){o.mode=!1,o.fromIndex=-1,o.toIndex=-1,o.selectionLength=0,o.justSelected=!1,o.node=null,o.isCENode=!1,o.array=[],o.currentIndex=-1}function r(e,t,n){console.log("Testing for placeholders:",{nodeType:e.nodeType,nodeName:e.nodeName,isContentEditable:e.isContentEditable,classes:e.className,content:t,startPosition:n}),window.Placeholder||(window.Placeholder={}),window.resetPlaceholderState(),window.Placeholder.node=e,window.Placeholder.isCENode=e.isContentEditable,window.Placeholder.fromIndex=n,window.Placeholder.mode=!1,window.Placeholder.array=[],window.Placeholder.currentIndex=-1,window.Placeholder.justSelected=!1;let o=e;if(e.isContentEditable){o=function(e){for(;e&&(!e.isContentEditable||null!==(t=e.parentElement)&&void 0!==t&&t.isContentEditable);){var t;e=e.parentElement}return e}(e),console.log("Root contenteditable node:",o);const n=d(t);console.log("Found placeholders in new content:",n);const l=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1);let r,c="";for(;r=l.nextNode();)c+=r.textContent;console.log("Full content from TreeWalker:",c);const i=d(c);console.log("Found all placeholders:",i);const a=[];if(n&&n.length>0&&a.push(...n),i&&i.forEach(e=>{null!=n&&n.includes(e)||a.push(e)}),console.log("Combined placeholders with priority:",a),0===a.length)return void console.log("No placeholders found");window.Placeholder.mode=!0,window.Placeholder.array=a,window.Placeholder.currentIndex=0;const s=a[0];console.log("First placeholder to select:",s),console.log("Looking for text node with placeholder in root:",o);const u=function(e,t){console.log("findTextNodeWithContent called with:",{nodeType:e.nodeType,nodeName:e.nodeName,searchText:t,nodeContent:3===e.nodeType?e.textContent:e.innerHTML});let n=e;for(;n&&(!n.isContentEditable||null!==(o=n.parentElement)&&void 0!==o&&o.isContentEditable);){var o;n=n.parentElement}if(!n)return console.error("Could not find root contenteditable container"),null;console.log("Found root contenteditable:",n),n.normalize();const l=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1);let r;for(;r=l.nextNode();)if(console.log("Checking text node:",{content:r.textContent,includes:r.textContent.includes(t)}),r.textContent.includes(t)){const e=r.textContent.indexOf(t);return console.log("Found placeholder in text node:",{node:r,text:r.textContent,placeholderIndex:e,placeholderText:t}),{node:r,start:e,end:e+t.length}}return console.log("No text node found containing:",t),null}(o,s);console.log("Found result:",u),u?(console.log("Setting range:",{node:u.node,start:u.start,end:u.end,text:u.node.textContent.substring(u.start,u.end)}),setTimeout(()=>{try{const e=window.getSelection(),t=document.createRange();t.setStart(u.node,u.start),t.setEnd(u.node,u.end),console.log("Range set, current selection:",{range:t.toString(),startOffset:t.startOffset,endOffset:t.endOffset,collapsed:t.collapsed}),e.removeAllRanges(),e.addRange(t),console.log("Selection updated:",{selectedText:e.toString(),rangeCount:e.rangeCount,type:e.type}),window.Placeholder.justSelected=!0,u.node.parentElement.scrollIntoView({behavior:"smooth",block:"center"}),console.log("Scrolled placeholder into view"),o.focus()}catch(e){console.error("Error in delayed selection:",e)}},0)):console.error("Text node for first placeholder not found")}else{const n=d(t);if(console.log("Found placeholders:",n),!n||0===n.length)return void console.log("No placeholders found");window.Placeholder.mode=!0,window.Placeholder.array=n,window.Placeholder.currentIndex=0;const o=n[0],l=t.indexOf(o);if(-1!==l){if(e.setSelectionRange(l,l+o.length),window.Placeholder.justSelected=!0,e.focus(),e.scrollHeight>e.clientHeight){const n=parseInt(window.getComputedStyle(e).lineHeight),o=t.substr(0,l).split("\n").length-1;e.scrollTop=o*n}}else console.error("First placeholder not found in content")}}function d(e,t=null){const n=/(%[^%\s]+%|\*\*)/g;if(!t){const t=[];let o;for(;null!==(o=n.exec(e));)t.push({text:o[0],index:o.index});return console.log("Found placeholders:",t),t.map(e=>e.text)}const o=[],l=document.createTreeWalker(t,NodeFilter.SHOW_TEXT);let r,d=0,c=0;for(;r=l.nextNode();){const e=r.textContent;let t;const l=new RegExp(n);for(;null!==(t=l.exec(e));)o.push({text:t[0],position:d+t.index,node:r,nodeOffset:t.index,id:c++});d+=e.length}return o.sort((e,t)=>e.position-t.position),console.log("Found placeholders in visual order:",o),window.Placeholder.positions=o,o.map(e=>e.text)}function c(e){if(!o.isCENode&&o.mode){const t=o.node.selectionStart;t>=o.fromIndex&&t<=o.toIndex&&(o.justSelected&&(o.justSelected=!1,e-=o.selectionLength),o.toIndex+=e)}}function i(e){"object"==typeof e&&e.body&&(e=e.body);try{const t=JSON.parse(e);if("quill-table-content"===t.type&&t.html){const e=document.createElement("div");e.innerHTML=t.html.trim();const n=e.querySelector("table");if(n){return n.removeAttribute("data-table"),n.removeAttribute("class"),n.style.cssText="border-collapse: collapse; width: 100%; margin: 10px 0; border: 1px solid #ccc;",n.querySelectorAll("td, th").forEach(e=>{e.removeAttribute("data-row"),e.removeAttribute("data-cell"),e.removeAttribute("class"),e.style.cssText="border: 1px solid #ccc; padding: 8px; text-align: left;";const t=e.querySelector(".ql-editor");t&&(e.innerHTML=t.innerHTML),e.querySelectorAll("*").forEach(e=>{e.className&&e.className.includes("ql-")&&e.removeAttribute("class")})}),n.outerHTML}return"<p>Error: Could not process table</p>"}if(t.ops){const e=t.ops.filter(e=>!e.insert||"string"!=typeof e.insert||""!==e.insert.trim());return t.ops=e,JSON.stringify(t)}return JSON.stringify(t)}catch(t){return console.log("Not a JSON snippet, treating as regular text"),"<div>"+String(e).replace(/[<>&]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;"})[e]).split("\n").join("<br>")+"</div>"}}function a(e,t){if(!e||!t)return console.error("Invalid parameters for insertSnippetInContentEditableNode:",{node:e,snip:t}),!1;try{const n=(e.ownerDocument.defaultView||e.ownerDocument.parentWindow).getSelection().getRangeAt(0),o=t.body;return console.log("Raw content before processing:",o),new Snip(t.name,t.body,t.timestamp).formatMacros(o=>{let l=o;console.log("Content after macro processing:",l);try{const e=JSON.parse(l);if("quill-table-content"===e.type&&e.html){let t=e.html.trim();t.includes("style=")||(t=t.replace("<table",'<table style="border-collapse: collapse; width: 100%;"')),t.includes("td style=")||(t=t.replace(/<td/g,'<td style="border: 1px solid #ccc; padding: 8px;"')),t.includes("th style=")||(t=t.replace(/<th/g,'<th style="border: 1px solid #ccc; padding: 8px; background-color: #f2f2f2;"')),l=t}}catch(e){l.includes("<")||(l=l.replace(/\n/g,"<br>"))}if(n.collapsed||n.deleteContents(),t.name){const e=n.startContainer.textContent.lastIndexOf(t.name);if(-1!==e){const o=document.createRange();o.setStart(n.startContainer,e),o.setEnd(n.startContainer,e+t.name.length),o.deleteContents()}}const d=n.startContainer,c=n.startOffset,i=document.createElement("div");i.innerHTML=l;const a=document.createDocumentFragment();for(;i.firstChild;)a.appendChild(i.firstChild);n.insertNode(a);const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.compareDocumentPosition(d)&Node.DOCUMENT_POSITION_PRECEDING?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let u,p="";for(;u=s.nextNode();)p+=u.textContent;console.log("New content for placeholder detection:",p),r(e,p,c);const f=new InputEvent("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(f)}),!0}catch(e){return console.error("Error in insertSnippetInContentEditableNode:",e),!1}}function s(e,t){if(console.log("Handling plain text tab navigation:",{nextPlaceholder:t,nodeType:e.nodeName,value:e.value,selectionStart:e.selectionStart,selectionEnd:e.selectionEnd}),!e||!t)return void console.error("Invalid node or placeholder");const n=e.value,l=e.selectionStart,r=n.indexOf(t,l),d=-1===r?n.indexOf(t):r;if(-1!==d){if(console.log("Found placeholder at position:",d),e.setSelectionRange(d,d+t.length),o.justSelected=!0,e.focus(),e.scrollHeight>e.clientHeight){const t=parseInt(window.getComputedStyle(e).lineHeight),o=n.substr(0,d).split("\n").length-1;e.scrollTop=o*t}}else console.error("Placeholder not found in text")}function u(e){if(console.log("Handling rich text tab navigation:",{placeholder:e}),window.Placeholder&&window.Placeholder.node)try{const e=window.getSelection(),n=document.createRange();let o=window.Placeholder.node;for(;o&&(!o.isContentEditable||null!==(t=o.parentElement)&&void 0!==t&&t.isContentEditable);){var t;o=o.parentElement}if(!o)return void console.error("Could not find root contenteditable container");console.log("Found root node for tab navigation:",o);const l=d("",o);console.log("Current remaining placeholders:",l);const r=window.Placeholder.positions||[];if(0===r.length)return console.log("No more placeholders to navigate to"),void(window.Placeholder.mode=!1);let c=-1;const i=e.toString();if(i){let t=0;const n=document.createTreeWalker(o,NodeFilter.SHOW_TEXT);let l;for(;(l=n.nextNode())&&l!==e.anchorNode;)t+=l.textContent.length;l===e.anchorNode&&(t+=e.anchorOffset);for(let e=0;e<r.length;e++){const n=r[e];if(n.text===i&&Math.abs(n.position-t)<i.length){c=e;break}}}const a=(c+1)%r.length,s=r[a];console.log("Navigation:",{currentSelection:i,currentPosition:c,nextPosition:a,nextPlaceholder:s}),s?(n.setStart(s.node,s.nodeOffset),n.setEnd(s.node,s.nodeOffset+s.text.length),e.removeAllRanges(),e.addRange(n),window.Placeholder.justSelected=!0,window.Placeholder.currentIndex=a,s.node.parentElement.scrollIntoView({behavior:"smooth",block:"center"}),o.focus()):console.error("Next placeholder position not found")}catch(e){console.error("Error in rich text tab navigation:",e)}else console.error("No placeholder node available")}function p(e){if(!o.mode||!o.array.length)return!1;const t=(o.currentIndex+1)%o.array.length;o.currentIndex=t;const n=o.array[t];return o.isCENode?u(n):s(e,n),!0}Object.assign(window,{Placeholder:o,testPlaceholderPresence:r,updatePlaceholderState:c,resetPlaceholderState:l,insertSnippetInContentEditableNode:a,prepareSnippetBody:i,handlePlainTextTabNavigation:s,handleRichTextTabNavigation:u,navigateToNextPlaceholder:p})}});