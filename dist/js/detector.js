!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=14)}([function(e,t,n){"use strict";n.d(t,"t",function(){return a}),n.d(t,"u",function(){return c}),n.d(t,"v",function(){return d}),n.d(t,"w",function(){return u}),n.d(t,"d",function(){return p}),n.d(t,"q",function(){return i}),n.d(t,"g",function(){return l}),n.d(t,"a",function(){return s}),n.d(t,"p",function(){return g}),n.d(t,"r",function(){return h}),n.d(t,"b",function(){return m}),n.d(t,"s",function(){return b}),n.d(t,"j",function(){return S}),n.d(t,"e",function(){return w}),n.d(t,"c",function(){return C}),n.d(t,"k",function(){return T}),n.d(t,"o",function(){return D}),n.d(t,"i",function(){return x}),n.d(t,"h",function(){return v}),n.d(t,"n",function(){return P}),n.d(t,"f",function(){return N}),n.d(t,"l",function(){return A}),n.d(t,"m",function(){return O}),n.d(t,"x",function(){return I});var o=n(5),r=n(6);function i(e){return e&&e.id&&e.url&&!r.e.BLOCKED_PATTERNS.some(t=>t.test(e.url))}function l(e){const t=function(){let e;try{throw new Error("")}catch(t){e=t.stack||""}return(e=e.split("\n").map(e=>e.trim())).splice("Error"===e[0]?2:1)}().join("\n");return function(...n){chrome.runtime.lastError&&(console.log("CRLError: ".concat(chrome.runtime.lastError.message)),console.log(t)),e&&e(...n)}}const s={q(e){return(this||document).querySelector(e)},Q(e){return(this||document).querySelectorAll(e)},qId(e){return(this||document).getElementById(e)},qCls(e){return[...(this||document).getElementsByClassName(e)]},qClsSingle(e){const t=(this||document).qCls(e);return t?t[0]:null}},{q:a,qCls:c,qClsSingle:d,qId:u,Q:p}=s;function g(e){return"[object Object]"===Object.prototype.toString.call(e)}function h(e){return 3===e.nodeType}a.new=function(e){return document.createElement(e)};const f=r.a.ENABLED,m=r.a.OBJECT_NAME_LIMIT,b=r.e.BLOCKED_PATTERNS[4];let y,E;f?(E=console.log.bind(console),y=console.dir.bind(console)):(E=function(){},y=function(){});const S=E,w=r.b.SHOW_CLASS,C=r.b.PRIMITIVES_EXT_KEY;function T(e){return e.replace(/[-[\]/{}())*+?.\\^$|]/g,"\\$&")}function D(e,t){const n=e&&e.tagName;if(!e||"TEXTAREA"===n||"INPUT"===n||!e.getAttribute)return!1;let o;const r=e.attr?e.attr("contenteditable"):null;if(""===r||"true"===r||"plaintext-only"===r)return!0;if(t)return!1;o=e;do{if(!(o=o.parentNode))return!1;if(D(o,!0))return!0}while(o!==window.document);return!1}function x(e,t=r.d.DEFAULT_DEBOUNCE_DELAY,n){let o;return function(...r){const i=this,l=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||e.apply(i,r)},t),l&&e.apply(i,r)}}function v(e){const t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="2em",t.style.height="2em",t.style.padding=0,t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")}catch(e){console.log("Oops, unable to copy")}document.body.removeChild(t)}function P(e){const t=e.replace(b,"");for(const e of Data.blockedSites){if(new RegExp("^".concat(T(e))).test(t))return!0}return!1}function N(e,t,n){const i=new Blob([t],{type:"text/js"});e.href=r.e.createObjectURL(i),e.download="".concat(n," ").concat(Object(o.d)(),".txt")}function A(e){return"<span class=notranslate>".concat(e,"</span>")}function O(e){return e.ownerDocument.defaultView}function I(e){e.dispatchEvent(new Event("input",{cancelable:!0,bubbles:!0}))}},function(e,t,n){"use strict";n.d(t,"b",function(){return a}),n.d(t,"d",function(){return s}),n.d(t,"c",function(){return l}),n.d(t,"a",function(){return c});var o=n(0),r=n(7),i=n(5);function l(){this.matchesUnique=function(e){return this.name.toLowerCase()===e.toLowerCase()},this.matchesNameLazy=function(e){return new RegExp(e,"i").test(this.name)},this.matchesLazy=function(e){return new RegExp(e,"i").test(this.name+this.strippedBody)},this.matchesWord=function(e){return new RegExp("\\b".concat(e,"\\b"),"i").test(this.name+this.strippedBody)},this.remove=function(){const e=Data.snippets.getUniqueObjectIndex(this.name,this.type),t=e[e.length-1];this.getParentFolder().list.splice(t,1),a.setIndices()},this.getParentFolder=function(){let e=Data.snippets.getUniqueObjectIndex(this.name,this.type),t=Data.snippets;for(let n=0,o=e.length-1;n<o;n++)t=t.list[e[n]];return t},this.moveTo=function(e){const t=this.getDuplicatedObject();return this.remove(),a.insertObject(t,e),t},this.canNestUnder=function(e){if(a.isFolder(this))for(;e.name!==a.MAIN_SNIPPETS_NAME;){if(this.name===e.name)return!1;e=e.getParentFolder()}return!0},this.getClone=function(){if(this.type===l.SNIP_TYPE)return new s(this.name,this.body,this.timestamp);const e=new a(this.name,[],this.timestamp);return this.list.forEach(t=>{e.list.push(t.getClone())}),e},this.insertAdjacent=function(e,t,n){const o=this.name,r=this.type,i=Data.snippets.getUniqueObjectIndex(o,r),l=i[i.length-1]+(t?+t:1)*(n?0:1);this.getParentFolder().list.splice(l,0,e),a.setIndices()}}function s(e,t,n){this.name=e,this.body=t,this.timestamp=n||Date.now(),this.type=l.SNIP_TYPE,this.edit=function(e,t){this.name=e;try{if("string"==typeof t&&t.startsWith("{")){const e=JSON.parse(t);if(e&&("quill-table-content"===e.type||"html"===e.type))return void(this.body=t)}}catch(e){console.log("Error parsing body JSON:",e)}this.body=JSON.stringify({type:"html",html:t,delta:null})},this.getDOMElement=function(e){const t=l.prototype.getDOMElement.call(this,e),n=t.qClsSingle("name"),r=o.t.new("div").addClass("body");function i(e){const o=function(e){try{if("string"==typeof e&&e.trim().startsWith("{")){const t=JSON.parse(e);if(t&&t.html)return"quill-table-content"===t.type?t.html.replace(/<table/g,'<table class="dotexpander-table"').replace(/<td/g,'<td class="prokeys-cell"').replace(/<th/g,'<th class="prokeys-cell"'):t.html}}catch(e){console.log("Content is not JSON, using as plain text")}return"<div>".concat(String(e).replace(/\n/g,"<br>"),"</div>")}(e.body);if(t.hasClass(s.DOMContractedClass)){const e=o.replace(/\<[^\>]+\>/g," ").replace(/\s+/g," ").replace(/&[^;]+;/g," ").trim().substring(0,s.MAX_COLLAPSED_CHARACTERS_DISPLAYED);r.text(e),setTimeout(()=>{r.style.width="calc(100% - 100px - ".concat(n.clientWidth,"px)")},1)}else r.html(o).style.width=""}t.appendChild(r),t.appendChild(o.t.new("div").addClass("clickable").on("click",l.prototype.preventButtonClickOverride(()=>{t.toggleClass(s.DOMContractedClass),i(this)}))),i(this);const a=o.t.new("div").addClass("timestamp").html(s.getTimestampString(this));return t.appendChild(a),t},this.getDuplicatedObject=function(){return new s(this.name,this.body,this.timestamp)},this.toArray=function(){return{name:this.name,body:this.body,timestamp:this.timestamp}},this.formatMacros=function(e){const t=[this.name],n={};function r(e,t,n,o){const r=(e=e.replace(new RegExp("^\\".concat(o)),"")).split(new RegExp("\\".concat(t),"g")).slice(0,n).join(t);return r?o+r:""}function l(e,t,n,o){return e.replace(new RegExp("^\\".concat(o)),"").split(t)[n-1]}let a=function e(o){return o.replace(/\[\[%s\((.*?)\)\]\]/g,(o,r)=>{if(t.indexOf(r)>-1)return o;const i=Data.snippets.getUniqueSnip(r),l=i&&i.name;return i?(t.push(l),n[l]?n[l]:(n[l]=e(i.body),n[l])):o})}(this.body);a=(a=(a=a.replace(/\[\[%d\((!?)(.*?)\)\]\]/g,(e,t,n)=>{let o,r,l,s,a,c,d=new Date,u=n;function p(e,n){let o=0;n?(n=parseInt(n,10),/M/.test(l)&&(o+=Object(i.e)(n)*i.b),o+=a*n):l=l.replace(/[^a-zA-Z\\/]/g,"").replace("\\d",""),t&&d.setTime(d.getTime()+o),c=t?d:new Date(Date.now()+o),u=u.replace(new RegExp(l),s(c))}t=!!t;for(const e of i.a)o=e,[l,[s,a]]=o,r=new RegExp(l,"g"),n.replace(r,p);return u})).replace(/\[\[%u\((.*?)\)\]\]/g,(e,t)=>{let n="",o=t.match(/(q?)\d+/),i=t.match(/q(\d+)/);return o=o?o[1]?0:+o[0]:100,i=i?i[1]?+i[1]:100:0,/p/i.test(t)&&(n+="".concat(window.location.protocol,"//")),/w/i.test(t)&&(n+="www."),n+=window.location.host,n+=r(window.location.pathname,"/",o,"/"),n+=r(window.location.search,"&",i,"?"),/h/i.test(t)&&(n+=window.location.hash),n})).replace(/\[\[%u\{(\w|\d+|q\d+)\}\]\]/g,(e,t)=>{let n;return Number.isInteger(+t)?l(window.location.pathname,"/",+t,"/"):"p"===t?window.location.protocol.replace(/:$/,""):"w"===t?"www":"h"===t?(({hash:n}=window.location),n&&n.substring(1)||""):"q"===t[0]?l(window.location.search,"&",+t.substring(1),"?"):""}),s.PASTE_MACRO_REGEX.test(a)?chrome.runtime.sendMessage("givePasteData",Object(o.g)(t=>{e(a.replace(s.PASTE_MACRO_REGEX,t))})):e(a)}}function a(e,t,n,i){function c(e){return function(){return this.list.reduce((t,n)=>n.type===e?t+1:t,0)}}function u(e){return function(t,n,o){const r=e?new s(t,n,o):new a(t,n,o);a.insertObject(r,this),window.latestRevisionLabel="created ".concat(r.type,' "').concat(r.name,'"')}}function p(e){return function(t,n,o){Data.snippets.getUniqueObject(t,e).edit(n,o),window.latestRevisionLabel="edited ".concat(e,' "').concat(t,'"')}}function g(e){return function(t){return this.getUniqueObject(t,e)}}function h(e){return function(t){return this.getUniqueObjectIndex(t,e)}}function f(e){const t=o.t.new("div").addClass("path_part"),n=o.t.new("div").addClass("right_arrow");t.dataset.name=e,$containerFolderPath.appendChild(t.html(Object(o.l)(e))),$containerFolderPath.appendChild(n)}function m(e,t){return t.replace(new RegExp(Object(o.k)(e),"ig"),e=>"<match>".concat(e,"</match>"))}function b(e){const t=function(n,o){this.list.forEach(r=>{!o&&a.isFolder(r)&&t.call(r,n,!1),r.type===e&&n(r)})};return t}console.log("[DEBUG] Creating new Folder:",{orgName:e,list:t,orgTimestamp:n,isSearchResultFolder:i}),console.log("[DEBUG] IN_OPTIONS_PAGE in Folder constructor:",window.IN_OPTIONS_PAGE),this.name=e,this.type=l.FOLDER_TYPE,this.timestamp=n||Date.now(),this.list=(t||[]).slice(0),this.isSearchResultFolder=!!i,window.IN_OPTIONS_PAGE&&(console.log("[DEBUG] In options page, observing list"),d(this.list)),this.getSnippetCount=c(l.SNIP_TYPE),this.getFolderCount=c(l.FOLDER_TYPE),this.getLastFolderIndex=function(){let e=0,t=this.list.length;for(;e<t&&a.isFolder(this.list[e]);)e++;return e-1},this.addSnip=u(!0),this.editSnip=p(l.SNIP_TYPE),this.addFolder=u(!1),this.editFolder=p(l.FOLDER_TYPE),this.edit=function(e){this.name=e},this.getDOMElement=function(e){return l.prototype.getDOMElement.call(this,e).on("click",l.prototype.preventButtonClickOverride(this.listSnippets.bind(this)))},this.getDOMElementFull=function(e){let t,n,r,i=o.t.new("div"),l=this.list.length;for(let o=0;o<l;o++)n=(t=this.list[o]).getDOMElement(e),i.appendChild(n);return 0===l&&((r=o.t.new("div")).addClass("empty_folder").html(this.isSearchResultFolder?"No matches found":"This folder is empty"),i.appendChild(r)),i},this.getUniqueObject=function(e,t){const n=this.getUniqueObjectIndex(e,t);if(!n)return null;let o=this;for(const e of n)o=o.list[e];return o},this.getUniqueObjectIndex=function(e,t){return a.indices[t][e.toLowerCase()]},this.getUniqueSnip=g(l.SNIP_TYPE),this.getUniqueSnipIndex=h(l.SNIP_TYPE),this.getUniqueFolder=g(l.FOLDER_TYPE),this.getUniqueFolderIndex=h(l.FOLDER_TYPE),this.stripAllSnippetsTags=function(e){e=e||o.t.new("DIV"),this.hasStrippedSnippets=!0,this.list.forEach(t=>{a.isFolder(t)?t.stripAllSnippetsTags(e):t.strippedBody=s.stripAllTags(t.body,e)})},this.searchSnippets=function(e){return e=Object(o.k)(e),this.hasStrippedSnippets||this.stripAllSnippetsTags(),new a(a.SEARCH_RESULTS_NAME+this.name,this.list.reduce((t,n)=>(a.isFolder(n)&&(t=t.concat(n.searchSnippets(e).list)),n.matchesLazy(e)&&t.push(n),t),[]).sort((t,n)=>n.matchesUnique(e)?1:t.matchesUnique(e)?-1:n.matchesNameLazy(e)?1:!t.matchesNameLazy(e)&&n.matchesWord(e)?1:-1),void 0,!0)},this.sort=function(e,t){const n="alphabetic"===e,o=this.getLastFolderIndex()+1,r=this.list.slice(0,o),i=this.list.slice(o);function l(e){return e.sort((e,t)=>{const o=e.name.localeCompare(t.name);return n?o:e.timestamp-t.timestamp||o}),t?e.reverse():e}this.list=l(r).concat(l(i))},this.listSnippets=function(e){e=Object(o.p)(e)?void 0:e,$containerSnippets.html("").appendChild(this.getDOMElementFull(e)),this.insertFolderPathDOM()},this.insertFolderPathDOM=function(){if($containerFolderPath.html(""),this.isSearchResultFolder)return void f(this.name);f(a.MAIN_SNIPPETS_NAME);let e=Data.snippets.getUniqueFolderIndex(this.name),t=Data.snippets;for(const n of e)f((t=t.list[n]).name);a.implementChevronInFolderPath()},this.toArray=function(){return[this.name,this.timestamp].concat(this.list.map(e=>e.toArray()))},this.filterSnippetsForOmnibox=function(e,t){const n=[],r=this.searchSnippets(e);r.forEachSnippet(t=>{t.formatMacros(r=>{r=function(e){const t=o.t.new("div");return t.innerHTML=e,t.innerText.replace(/\n/g," ")}(r);const i="<url>".concat(m(e,t.name),"</url> - ")+"<dim>".concat(m(e,r),"</dim>");n.push({content:r,description:i,deletable:!0})})});const i=setInterval(()=>{n.length===r.getSnippetCount()&&(clearInterval(i),t(n))},100)},this.getFolderSelectList=function(e){let t,n=o.t.new("div"),r=o.t.new("p").html(Object(o.l)(this.name)),i=!1;return r.dataset.name=this.name,n.appendChild(r),this.name!==a.MAIN_SNIPPETS_NAME&&n.addClass("collapsed"),this.forEachFolder(o=>{o.name!==e&&(i=!0,(t=o.getFolderSelectList(e)).style.marginLeft="15px",n.appendChild(t))},!0),i||n.addClass("empty"),n},this.getDuplicatedObject=function(){return new a(this.name,this.list,this.timestamp)},this.getUniqueSnippetAtCaretPos=function(e,t){let n,i=Object(r.c)(e),l="",s=null,a=i[t-1],c=t<o.b?t:o.b;for(let e=1;e<=c;e++){l=a+l,a=i[t-1-e],n=this.getUniqueSnip(l);const r=new RegExp("[".concat(Object(o.k)(Data.snipNameDelimiterList),"]"));if(n&&(Data.matchDelimitedWord&&r&&a&&!r.test(a)&&"\n"!==a||(s=n)),s)break}return s},this.createCtxMenuEntry=function(e){let t;this.list.forEach(n=>{t=l.CTX_START[n.type]+n.name,chrome.contextMenus.create({contexts:["editable"],id:t,title:n.name,parentId:e},Object(o.g)()),listOfSnippetCtxIDs.push(t),a.isFolder(n)&&n.createCtxMenuEntry(t)}),0===this.list.length&&(t="Empty folder "+this.name,chrome.contextMenus.create({contexts:["editable"],id:t,title:"Empty folder ",parentId:e},Object(o.g)()),listOfSnippetCtxIDs.push(t))},this.forEachSnippet=b(l.SNIP_TYPE),this.forEachFolder=b(l.FOLDER_TYPE)}function c(e,t){const n=t?"normal-editor":"ql-editor",r=!t,i=o.t.new("DIV").addClass("nav"),l=o.t.new("SPAN").text("Swap editor mode: "),a=o.t.new("P").text("Textarea").addClass(o.e),c=o.t.new("P").text("Styled textbox");this.isCurrModePlain=!0,this.isQuillInitialized=!1,this.quillInitPromise=null,this.$textarea=null,this.$richEditor=null,this.quill=null,a.dataset.containerSelector="textarea",c.dataset.containerSelector=".".concat("rich_editor_container"),a.dataset.editorSelector="textarea",c.dataset.editorSelector=".".concat(n),i.appendChild(l),i.appendChild(a),i.appendChild(c),e.appendChild(i),e.addClass("dualBoxContainer"),this.$textarea=o.t.new("TEXTAREA").addClass([o.e,a.dataset.containerSelector]);const d=o.t.new("DIV").addClass("rich_editor_container");this.$richEditor=o.t.new("DIV"),e.appendChild(this.$textarea),d.appendChild(this.$richEditor),e.appendChild(d),t?(this.$richEditor.addClass(n).attr("contenteditable","true"),this.quillInitPromise=Promise.resolve(null),this.isQuillInitialized=!0):this.quillInitPromise=function(e,t){console.log("[DEBUG] Starting Quill initialization");const n="editor-".concat(Math.random().toString(36).substr(2,9)),o="toolbar-".concat(n),r=document.createElement("div");return r.id=o,r.className="ql-toolbar ql-snow",t.insertBefore(r,e),e.id=n,new Promise(t=>{try{const n=(o=0)=>{if(o>=50)return console.error("[DEBUG] Dependencies not available after maximum retries"),void t(null);if("undefined"==typeof Quill||"undefined"==typeof QuillTableBetter)return console.log("[DEBUG] Waiting for Quill and QuillTableBetter...",o),void setTimeout(()=>n(o+1),100);try{console.log("[DEBUG] Registering table-better module"),Quill.register({"modules/table-better":QuillTableBetter},!0);const n=new Quill(e,{modules:{toolbar:{container:[["bold","italic","underline","strike"],["blockquote","code-block","link"],[{list:"ordered"},{list:"bullet"},{list:"check"}],[{script:"sub"},{script:"super"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["table-better","image"],["clean"]]},"table-better":{operationMenu:{items:{unmergeCells:{text:"Unmerge cells"}}},menus:["column","row","merge","table","cell","wrap","delete"],toolbarTable:!0,tableStyles:{width:"100%",height:"auto",table:{width:"100%","border-collapse":"collapse"},cell:{border:"1px solid #000",padding:"8px","min-width":"50px"}}}},theme:"snow",placeholder:"Start typing..."});console.log("[DEBUG] Quill instance created"),t(n)}catch(e){console.error("[DEBUG] Error during Quill initialization:",e),t(null)}};n()}catch(e){console.error("[DEBUG] Error in initializeQuill:",e),t(null)}})}(this.$richEditor,d).then(t=>t?(this.quill=t,this.$richEditor=e.querySelector(c.dataset.editorSelector),this.isQuillInitialized=!0,t):(console.error("[DEBUG] Failed to initialize Quill editor"),null));const u=async t=>{try{this.isQuillInitialized||await this.quillInitPromise;let n,i,l=e.querySelectorAll(".".concat(o.e)),a=l[1];const c=this.isCurrModePlain?this.getPlainText():this.getRichText();let d=null;try{d=JSON.parse(c)}catch(e){}l&&l.length>0&&(l.forEach(e=>e.removeClass(o.e)),a&&a.removeAttribute("tab-index")),t&&(t.addClass(o.e),n=e.querySelector(t.dataset.containerSelector),i=e.querySelector(t.dataset.editorSelector),n&&i&&(n.addClass(o.e),i.attr("tab-index",20),i.focus()));const u=this.isCurrModePlain;this.isCurrModePlain=!u,c&&c.trim()?d&&"quill-table-content"===d.type?this.isCurrModePlain?this.setPlainText(c):this.loadContent(c):r&&(this.isCurrModePlain?u?this.setPlainText(c):this.setPlainText(s.makeHTMLSuitableForTextareaThroughString(c)):this.loadContent(c)):this.isCurrModePlain?this.setPlainText(""):this.loadContent("")}catch(e){return console.error("Error in editor swap:",e),!1}};i.on("click",async e=>{const t=e.detail&&e.detail.target||e.target;if("P"!==t.tagName||t.hasClass(o.e))return!1;const n=this.isCurrModePlain?this.getPlainText():this.getRichText();return console.log("[DEBUG] Current content before trim:",n),(this.isCurrModePlain||""!==n&&"<p><br></p>"!==n&&"<p><br></p><p><br></p>"!==n)&&n&&n.trim()?(console.log("[DEBUG] Editor switch prevented - content present"),!1):u(t)}),this.userAllowsToLoseFormattingOnSwapToTextarea=function(){const e=s.getQuillClsForFormattedLossyContent(this.$richEditor.innerHTML);return!(e&&!window.confirm("We detected formatted text ".concat(e," in your expansion. You will lose it after this swap. Are you sure you wish to continue?")))},this.switchToDefaultView=async function(e){await this.quillInitPromise;const t=s.isSuitableForPastingInTextareaAsIs(e)?a:c;return await u(t),this},this.setPlainText=function(e){if(console.log("[DEBUG] Setting plain text input type:",typeof e),console.log("[DEBUG] Setting plain text input value:",e),!e)return this.$textarea.value="",this;try{let t;if(e&&"object"==typeof e&&e.body){console.log("[DEBUG] Found object with body property"),console.log("[DEBUG] Body type:",typeof e.body),console.log("[DEBUG] Body value:",e.body);try{t=JSON.parse(e.body),console.log("[DEBUG] Successfully parsed body into:",t)}catch(t){console.log("[DEBUG] Error parsing body:",t),console.log("[DEBUG] Failed to parse body:",e.body)}}else if("string"==typeof e){console.log("[DEBUG] Attempting to parse string input");try{t=JSON.parse(e),console.log("[DEBUG] Successfully parsed string into:",t)}catch(t){console.log("[DEBUG] Failed to parse string:",e)}}else console.log("[DEBUG] Using input as is:",e),t=e;if(t&&"quill-table-content"===t.type){console.log("[DEBUG] Found quill-table-content"),console.log("[DEBUG] HTML content:",t.html),console.log("[DEBUG] Delta content:",t.delta);const e=document.createElement("div");let n=t.html;console.log("[DEBUG] Step 1 - Original HTML:",n),n=n.replace(/\\&quot;|&quot;|\\"/g,'"').replace(/\\"([^"]+)\\"/g,'"$1"').replace(/\\n/g,"\n").replace(/class="[^"]*"/g,"").replace(/style="[^"]*"/g,"").replace(/data-[^=]+="[^"]*"/g,"").replace(/width="[^"]*"/g,"").replace(/height="[^"]*"/g,"").replace(/<temporary[^>]*>.*?<\/temporary>/g,"").replace(/<br\/?>/g,"").replace(/<tbody>/g,"").replace(/<\/tbody>/g,""),console.log("[DEBUG] Step 2 - After cleanup:",n),e.innerHTML=n,console.log("[DEBUG] Step 3 - After setting innerHTML:",e.innerHTML);const o=e.querySelector("table");if(o){console.log("[DEBUG] Found table element:",o.outerHTML);const e=Array.from(o.querySelectorAll("tr"));if(console.log("[DEBUG] Found rows:",e.length),console.log("[DEBUG] Row elements:",e.map(e=>e.outerHTML)),0===e.length)return console.log("[DEBUG] No rows found in table"),this;const t=e.map((e,t)=>{console.log("[DEBUG] Processing row ".concat(t," HTML:"),e.innerHTML);const n=Array.from(e.querySelectorAll("td"));return console.log("[DEBUG] Found ".concat(n.length," cells in row ").concat(t)),n.map((e,n)=>{const o=e.querySelector("p");console.log("[DEBUG] Cell [".concat(t,",").concat(n,"] HTML:"),e.innerHTML),console.log("[DEBUG] Cell [".concat(t,",").concat(n,"] p element:"),o?o.outerHTML:"none");const r=(o?o.textContent:e.textContent).trim();return console.log("[DEBUG] Cell [".concat(t,",").concat(n,"] extracted content:"),r),r||" "})});console.log("[DEBUG] Final extracted table data:",t);const n=[];for(let e=0;e<t[0].length;e++)n[e]=Math.max(3,...t.map(t=>(t[e]||"").length)),console.log("[DEBUG] Column ".concat(e," width:"),n[e]);const r=Math.max(...n);n.fill(r),console.log("[DEBUG] Using consistent width for all columns:",r);let i="\n";const l="+"+n.map(e=>"-".repeat(e+2)).join("+")+"+\n";return console.log("[DEBUG] Separator line:",l),i+=l,t.forEach((e,t)=>{const o="|"+e.map((e,t)=>" "+e.padEnd(n[t])+" ").join("|")+"|\n";console.log("[DEBUG] Row ".concat(t," ASCII:"),o),i+=o+l}),console.log("[DEBUG] Final ASCII table:",i),this.$textarea.value=i,this}console.log("[DEBUG] No table element found in cleaned HTML")}else console.log("[DEBUG] Content is not quill-table-content:",t);if(t&&t.html){console.log("[DEBUG] Handling as regular HTML content");const e=document.createElement("div");return e.innerHTML=t.html,this.$textarea.value=e.textContent.trim(),this}if(t&&t.delta&&t.delta.ops){console.log("[DEBUG] Handling as delta content"),console.log("[DEBUG] Delta ops:",t.delta.ops);const e=t.delta.ops.map(e=>e.insert||"").join("").trim();return console.log("[DEBUG] Extracted text from delta:",e),this.$textarea.value=e,this}}catch(e){console.log("[DEBUG] Error in setPlainText:",e),console.log("[DEBUG] Error stack:",e.stack)}return console.log("[DEBUG] Falling back to plain text handling"),this.$textarea.value="string"==typeof e?e:String(e),this},this.getShownTextForSaving=async function(){if(console.log("[DEBUG] getShownTextForSaving called"),await this.quillInitPromise,this.isCurrModePlain)return s.sanitizeTextareaTextForSave(this.$textarea.value);if(!this.quill)return console.error("[DEBUG] Quill not initialized"),"";const e=this.quill.root.innerHTML,t=this.quill.getContents();return JSON.stringify({type:"quill-table-content",html:e,delta:t})}}function d(e){const t=["push","pop","shift","unshift","splice"];for(const n of t)Object.defineProperty(e,n,{configurable:!1,enumerable:!1,writable:!1,value:function(t){return function(...n){const o=[][t].apply(e,n);return a.setIndices(),o}}(n)})}l.HIGHLIGHTING_CLASS="highlighting",l.FOLDER_TYPE="folder",l.SNIP_TYPE="snip",l.CTX_START={},l.CTX_START[l.SNIP_TYPE]="".concat(l.SNIP_TYPE,"_"),l.CTX_START[l.FOLDER_TYPE]="".concat(l.FOLDER_TYPE,"_"),l.CTX_SNIP_REGEX=new RegExp(l.CTX_START[l.SNIP_TYPE]),l.prototype.getDOMElement=function(e){e=void 0===e?[]:Array.isArray(e)?e:[e];const t=o.t.new("div").addClass([this.type,"generic",s.DOMContractedClass]),n=o.t.new("img");n.src="../imgs/".concat(this.type,".svg"),t.appendChild(n);const r=o.t.new("div").html(Object(o.l)(this.name)).addClass("name");return r.dataset.name=this.name,t.appendChild(r),t.appendChild(this.getButtonsDOMElm()),e.indexOf(this.name)>-1&&(!1!==e[0]&&t.removeClass(s.DOMContractedClass),t.addClass(l.HIGHLIGHTING_CLASS),setTimeout(()=>{t.removeClass(l.HIGHLIGHTING_CLASS)},3e3)),t},l.prototype.getButtonsDOMElm=function(){const e=document.createElement("div");e.className="buttons";const t=document.createElement("div");t.classList.add("edit_btn"),t.classList.add("panel_btn"),t.title="Edit";const n=document.createElement("div");n.classList.add("delete_btn"),n.classList.add("panel_btn"),n.title="Delete";const o=document.createElement("div");return o.classList.add("clone_btn"),o.classList.add("panel_btn"),o.title="Clone",e.appendChild(t),e.appendChild(n),e.appendChild(o),e},l.prototype.preventButtonClickOverride=function(e){return function(t){t.target.matches(".buttons, .buttons div")||e.call(this,t)}},l.prototype.getDuplicateObjectsText=function(e,t){return"A ".concat(t," with name '").concat(e,"' already exists (possibly with the same letters in upper/lower case.)")},l.prototype.isValidName=function(e,t){if(0===e.length)return"Empty name field";if(e.length>o.b)return"Name cannot be greater than ".concat(o.b," characters. Current name has ").concat(e.length-o.b," more characters.");try{return Data.snippets.getUniqueObject(e,t)?l.getDuplicateObjectsText(e,t):"true"}catch(e){return"true"}},l.prototype.getObjectThroughDOMListElm=function(e){const t=e.classList.contains("snip")?l.SNIP_TYPE:l.FOLDER_TYPE,{name:n}=e.qClsSingle("name").dataset;return Data.snippets.getUniqueObject(n,t)},s.prototype=new l,s.MAX_COLLAPSED_CHARACTERS_DISPLAYED=200,s.DOMContractedClass="contracted",s.PASTE_MACRO_REGEX=/\[\[%p\]\]/gi,s.CARET_POSITION_CLASS="caretPlacement",s.CARET_POSITION_EMPTY_REGEX=/\[\[%c(\(\))?\]\]/,s.CARET_POSITION_STUFFED_REGEX=/\[\[%c\([v^<>\d]+\)\]\]/,s.CARET_POSITION_SELECTION_START_REGEX=/\[\[%c\(s\)\]\]/,s.CARET_POSITION_SELECTION_END_REGEX=/\[\[%c\(e\)\]\]/,s.CARET_POSITION_SELECTION_END_STRING="[[%c(e)]]",s.fromObject=function(e){const t=new s(e.name,e.body);return t.timestamp=e.timestamp?"number"==typeof e.timestamp?e.timestamp:Date.parse(e.timestamp.substring(11)):Date.now(),t},s.isValidName=function(e){const t=l.isValidName(e,l.SNIP_TYPE);return/^%.+%$/.test(e)?"Name cannot be of the form '%abc%'":t},s.isValidBody=function(e){return e.length?"true":"Empty body field"},s.getTimestampString=function(e){return"Created on ".concat(Object(i.d)(e.timestamp))},s.makeHTMLSuitableForTextareaThroughString=function(e){const t=document.createElement("div");return t.innerHTML=e,s.makeHTMLSuitableForTextarea(t)},s.makeHTMLSuitableForTextarea=function(e){console.log("[DEBUG] makeHTMLSuitableForTextarea input:",e.innerHTML);try{if(e.innerHTML.includes("quill-table-content")){console.log("[DEBUG] Found table content");const t=document.createElement("div");t.innerHTML=e.innerHTML;const n=t.querySelector("table");if(n){console.log("[DEBUG] Found table element:",n.outerHTML);const e=Array.from(n.querySelectorAll("tr"));if(console.log("[DEBUG] Found rows:",e.length),0===e.length)return console.log("[DEBUG] No rows found"),"";const t=e.map((e,t)=>(console.log("[DEBUG] Processing row ".concat(t,":"),e.innerHTML),Array.from(e.querySelectorAll("td")).map((e,n)=>{const o=e.querySelector("p"),r=(o?o.textContent:e.textContent).trim();return console.log("[DEBUG] Cell [".concat(t,",").concat(n,"] content:"),r),r||" "})));console.log("[DEBUG] Table data:",t);const o=[];for(let e=0;e<t[0].length;e++)o[e]=Math.max(3,...t.map(t=>(t[e]||"").length));let r="\n";const i="+"+o.map(e=>"-".repeat(e+2)).join("+")+"+\n";return r+=i,t.forEach(e=>{r+="|"+e.map((e,t)=>" "+e.padEnd(o[t])+" ").join("|")+"|\n"+i}),console.log("[DEBUG] ASCII table:",r),r}const o=e.innerHTML.match(/"delta":\s*({[^}]+})/);if(o){console.log("[DEBUG] Found delta content");try{const e=JSON.parse(o[1]);if(e.ops){const t=e.ops.map(e=>e.insert&&"object"==typeof e.insert&&e.insert.image?"[Pictures cannot be displayed in plain-text boxes.]":e.insert||"").join("").trim();return console.log("[DEBUG] Extracted text from delta:",t),t}}catch(e){console.log("[DEBUG] Error parsing delta:",e)}}}function t(e){const t=e.tagName.toLowerCase(),n=["<".concat(t,">"),"</".concat(t,">")];return"a"===t&&(n[0]="<a href='".concat(e.href,"'>")),"span"!==t?n:["",""]}function n(e){if(Object(o.r)(e))return e.textContent;let r,i,l,s,a,{tagName:c}=e,d="",u=e.childNodes,p=0,g=u.length;if("IMG"===c)return"[Pictures cannot be displayed in plain-text boxes.]";if("PRE"===c)return(i=t(e))[0]+e.innerHTML+i[1];if("P"===c&&1===g){if(a=(s=u[0]).innerText||s.textContent,"BR"===s.tagName)return"";if(0===a.length)return""}for(;p<g;p++)1===(r=u[p]).nodeType?(l=(i=t(r))[0]+n(r)+i[1],"LI"===r.tagName?d+="    ".concat(l,"\n"):d+=l):d+=r.textContent;switch(c){case"BLOCKQUOTE":return"<blockquote>".concat(d,"</blockquote>");case"OL":return"<ol>\n".concat(d,"</ol>");case"UL":return"<ul>\n".concat(d,"</ul>");case"TABLE":return"<table>".concat(d,"</table>");case"TR":return"<tr>".concat(d,"</tr>");default:return d}}console.log("[DEBUG] Handling as regular HTML");let r,i,l=e.childNodes,s="",a=l.length,c=0;for(;c<a;)s+="<!!>"===(i=n(r=l[c]))?"":"".concat(i,"\n"),c++;return s=(s=s.replace(/&nbsp;/g," ")).substring(0,s.length-1),console.log("[DEBUG] Final output:",s),s}catch(e){return console.log("[DEBUG] Error in makeHTMLSuitableForTextarea:",e),console.log("[DEBUG] Error stack:",e.stack),""}},s.isSuitableForPastingInTextareaAsIs=function(e){return!(s.hasFormattedLossyContentWoQuillCls(e)||/<p>|<br>/.test(e))},s.hasFormattedLossyContentWoQuillCls=function(e){const t=[/background-color: /,/color: /,/text-align: /,/font-size: /,/font-family: /];for(let n=0,o=t.length;n<o;n++)if(t[n].test(e))return!0;return!1},s.getQuillClsForFormattedLossyContent=function(e){const t=[[/ql-font/,"font"],[/ql-align/,"alignment"],[/ql-size/,"size"],[/color: /,"color"],[/background-color: /,"background color"]];for(let n=0,o=t.length;n<o;n++)if(t[n][0].test(e))return t[n][1];return null},s.stripAllTags=function(e,t){t||(t=o.t.new("DIV")),e&&(t.innerHTML=e);const{tagName:n}=t;switch(n){case"DIV":case"OL":case"UL":break;default:return t.innerText.replace(/\n/g," ")}const r=t.childNodes,i=r.length;let l="",a=0;if(0===i)return t.innerText.replace(/\n/g," ");for(;a<i;a++)l+="".concat(s.stripAllTags("",r[a]),"\n");return l},s.defaultLinkSanitize=function(e){return e=e.replace(/^chrome-extension:\/\/[a-z]+\/html\//,""),/^\w+:/.test(e)||/^https?:/.test(e)||(e="http:".concat(e)),e},s.formatOLULInListParentForTextarea=Object(r.a)("    ","\n"),s.sanitizeTextareaTextForSave=function(e){const t=o.t.new("div");return t.innerHTML=e,t.innerHTML=t.innerHTML.replace(/&nbsp;/g," "),t.querySelectorAll("a").forEach(e=>{e.href=s.defaultLinkSanitize(e.href)}),t.querySelectorAll("ol, ul").forEach(s.formatOLULInListParentForTextarea),t.innerHTML},s.validate=function(e,t,n){let r,i,c=["name","body","timestamp"],d=c.length,u={body:s.isValidBody,name:s.isValidName},p="".concat(n,"th snippet under folder ").concat(t);if(Array.isArray(e)){if("true"!==(i=a.validate(e)))return i}else{if(!Object(o.p)(e))return"".concat(p," is not an object.");{let t=0;for(const n of Object.keys(e)){if(-1===c.indexOf(n)){delete e[n];continue}t++,r=e[n];const o=u[n];if(o&&("true"!==(i=o(r))&&l.getDuplicateObjectsText(r,l.SNIP_TYPE)!==i))return"Invalid value for property ".concat(n," in ").concat(p,"; received error: ").concat(i)}if(t!==d)return"".concat(p," is missing one of the properties: ").concat(JSON.stringify(c))}}return"true"},a.prototype=new l,a.fromArray=function(e){"string"!=typeof e[0]&&e.unshift(a.MAIN_SNIPPETS_NAME),"number"!=typeof e[1]&&e.splice(1,0,Date.now());const t=new a(e.shift(),void 0,e.shift());return t.list=e.map(e=>Array.isArray(e)?a.fromArray(e):s.fromObject(e)),window.IN_OPTIONS_PAGE&&d(t.list),t},a.isValidName=function(e){return l.isValidName(e,l.FOLDER_TYPE)},a.isFolder=function(e){return e&&e.type===l.FOLDER_TYPE},a.makeFolderIfList=function(e){e&&Array.isArray(e.snippets)&&(e.snippets=a.fromArray(e.snippets))},a.makeListIfFolder=function(e){a.isFolder(e.snippets)&&(e.snippets=e.snippets.toArray())},a.MAIN_SNIPPETS_NAME="Snippets",a.SEARCH_RESULTS_NAME="Search Results in ",a.CHEVRON_TEXT="<<",a.setIndices=function(){function e(e,t,n){a.indices[e][t.toLowerCase()]=n}a.indices={},a.indices[l.FOLDER_TYPE]={},a.indices[l.SNIP_TYPE]={},!1!==Data.snippets&&function t(n,o){let r,i=0;e(n.type,n.name,o),n.list.forEach(n=>{r=o.concat(i),a.isFolder(n)?t(n,r):e(n.type,n.name,r),i++})}(Data.snippets,[])},a.copyContents=function(e,t){const{list:n}=e;for(let e=n.length-1;e>=0;e--)a.insertObject(n[e].getDuplicatedObject(),t)},a.insertObject=function(e,t){a.isFolder(e)?t.list.unshift(e):t.list.splice(t.getLastFolderIndex()+1,0,e)},a.insertBulkActionDOM=function(e){const t=o.t.new("div");return e.list.forEach(e=>{const n=o.t.new("div").addClass("generic"),r=o.t.new("input"),i=o.t.new("img"),l=o.t.new("div").addClass("name").html(Object(o.l)(e.name));l.dataset.name=e.name,r.type="checkbox",i.src="../imgs/".concat(e.type,".svg"),n.appendChild(r),n.appendChild(i),n.appendChild(l),t.appendChild(n)}),$containerSnippets.html("").appendChild(t),t},a.getSelectedFolderInSelectList=function(e){const t=e.qClsSingle("selected").dataset.name;return Data.snippets.getUniqueFolder(t)},a.refreshSelectList=function(e){e.html("").appendChild(Data.snippets.getFolderSelectList()),e.children[0].children[0].addClass("selected")},a.implementChevronInFolderPath=function(e){const t=15;const n=$containerFolderPath.offsetWidth,o=function(){let e=0,n=[].slice.call($containerFolderPath.children,0).reduce((t,n)=>n.hasClass("right_arrow")?(e++,t):t+n.offsetWidth,0);return n+=e*t}(),r=$containerFolderPath.lastChild.previousElementSibling,i=a.getListedFolder();if(o>n){const e=$containerFolderPath.querySelector(".path_part:not(.chevron)");if(e===r)e.style.width="".concat($containerFolderPath.offsetWidth-t-50,"px"),e.addClass("ellipsized");else{const t=!!$containerFolderPath.querySelector(".chevron");$containerFolderPath.removeChild(e.nextElementSibling),t?$containerFolderPath.removeChild(e):e.addClass("chevron").html(a.CHEVRON_TEXT),a.implementChevronInFolderPath(!0)}}else!e&&$containerFolderPath.querySelector(".chevron")&&i.insertFolderPathDOM()},a.getListedFolderName=function(){return $containerFolderPath.querySelector(":nth-last-child(2)").dataset.name},a.getListedFolder=function(){let e=a.getListedFolderName();return-1!==e.indexOf(a.SEARCH_RESULTS_NAME)&&(e=e.substring(a.SEARCH_RESULTS_NAME.length)),Data.snippets.getUniqueFolder(e)},a.validate=function(e){"string"!=typeof e[0]&&(e.unshift(Date.now()),e.unshift(a.MAIN_SNIPPETS_NAME));const t=e[0],n=e[1],o=e.slice(2),r="Folder ".concat(t);let i;if("string"!=typeof t)return"Name of ".concat(r," is not a string.");const c=a.isValidName(t);if("true"!==c&&l.getDuplicateObjectsText(t,l.FOLDER_TYPE)!==c)return"Name of ".concat(r," is invalid because: ").concat(c);if("number"!=typeof n)return"Timestamp for ".concat(r," is not a number");for(let e,n=0,r=o.length;n<r;n++)if(e=o[n],"true"!==(i=s.validate(e,t,n)))return i;return"true"},a.getDefaultSnippetData=function(){const e=Date.now(),t=new a(a.MAIN_SNIPPETS_NAME,[],e);return t.list=[new a("sampleFolder",[],e),new s("sampleSnippet","Hello new user! Thank you for using DotExpander!\n\nThis is a sample snippet. Try using it on any webpage by typing 'sampleSnippet' (snippet name; without quotes), and press the hotkey (default: Shift+Space), and this whole text would come in place of it.",e),new s("letter","(Sample snippet to demonstrate the power of DotExpander snippets; for more detail on Placeholders, see the Help section)\n\nHello %name%,\n\nYour complaint number %complaint% has been noted. We will work at our best pace to get this issue solved for you. If you experience any more problems, please feel free to contact at me@organization.com.\n\nRegards,\n%my_name%,\nDate: [[%d(D-MM-YYYY)]]",e),new s("brb","be right back",e),new s("my_sign","<b>DotExpander &#169;</b>\n<i>Created by DoctorDurant LLC</i>\n<u>james@doctordurant.com</u>",e),new s("dateArithmetic","Use this snippet in any webpage, and you'll see that the following: [[%d(Do MMMM YYYY hh:m:s)]] is replaced by the current date and time.\n\nMoreover, you can perform date/time arithmetic. The following: [[%d(D+5 MMMM+5 YYYY+5 hh-5:m-5:s-5)]] gives the date, month, year, forward by five; and hour, minutes, and seconds backward by 5.\n\nMore info on this in the Help section.",e),new s("urlMacro","Use the URL macro (details in the Help page) to retrieve parts of the URL of the active webpage. For example, [[%u(host)]] gives the hostname.",e),new s("README-New_UI_Details","Dear user, here are some things you need to know in this new UI:\n\n1. You need to click on the name or body of the listed snippet to expand it completely. In the following image, the purple area shows where you can click to expand the snippet.\n\n<img src='../imgs/help1.png'>\n\n2. Click on the pencil icon to edit and the dustbin icon to delete a snippet/folder.\n3. Click on the folder, anywhere in the purple area denoted below, to view its contents.\n\n<img src='../imgs/help2.png'>\n\n4. Click on a folder name in the navbar to view its contents. In the example below, the navbar consists of 'Snippets', 'sampleFolder' and 'folder2',  each nested within the previous.\n\n<img src='../imgs/help3.png'>",e),new s("clipboard_macro","Use this snippet anywhere and the following - [[%p]] - will be replaced by  your clipboard data. Clipboard data includes text that you have previously copied or cut with intention to paste.",e)],t},c.prototype.getPlainText=function(){return this.$textarea.value},c.prototype.getRichText=function(){return this.quill&&this.quill.getLength()<=1?"":this.$richEditor.innerHTML},c.prototype.setRichText=async function(e){if(console.log("[DEBUG] Setting rich text:",e),!this.isQuillInitialized&&this.quillInitPromise&&(console.log("[DEBUG] Waiting for Quill initialization"),await this.quillInitPromise),this.quill){try{if(this.isCurrModePlain&&e&&"object"==typeof e&&"quill-table-content"===e.type){console.log("[DEBUG] Auto-switching to rich text mode for table content");const e=document.querySelector(".nav p:not(.show)");e&&(e.click(),await new Promise(e=>setTimeout(e,100)))}this.loadContent(e)}catch(e){console.error("[DEBUG] Error in setRichText:",e),this.quill.setText("")}return this}console.error("[DEBUG] Quill not available")},c.prototype.loadContent=function(e){console.log("[DEBUG] Loading content:",e);try{if(!this.quill)return void console.error("[DEBUG] Quill not initialized");let t,n=e;if("string"==typeof e&&e.trim())try{n=JSON.parse(e)}catch(e){console.log("[DEBUG] Content is not JSON structured")}const o=e=>e&&(e.includes("<table")||e.includes("</table>")||e.includes("<td")||e.includes("</td>")||e.includes("<th")||e.includes("</th>"));if(n&&"object"==typeof n){if("quill-table-content"===n.type&&n.html)if(o(n.html))if(console.log("[DEBUG] Loading structured table content with HTML:",n.html),n.delta&&n.delta.ops){console.log("[DEBUG] Using stored delta"),t=new(this.quill.constructor.import("delta"))(n.delta.ops)}else console.log("[DEBUG] Converting HTML to delta"),t=this.quill.clipboard.convert(n.html);else console.log("[DEBUG] Content marked as table but no table found - treating as regular content"),t=this.quill.clipboard.convert(n.html);else if(n.ops){console.log("[DEBUG] Using provided delta"),t=new(this.quill.constructor.import("delta"))(n.ops)}}else"string"==typeof n&&(console.log("[DEBUG] Converting HTML/text content"),t=this.quill.clipboard.convert(n));if(!t||!t.ops||!t.ops.length){console.log("[DEBUG] No valid delta content, creating empty delta"),t=(new(this.quill.constructor.import("delta"))).insert("\n")}console.log("[DEBUG] Final delta to apply:",t),this.quill.setText(""),this.quill.updateContents(t,Quill.sources.USER),this.quill.focus(),this.quill.setSelection(0,0),console.log("[DEBUG] Content loaded successfully")}catch(e){console.error("[DEBUG] Error loading content:",e),this.quill.setText("")}},s.getPreviewText=function(e){try{const t="string"==typeof e?JSON.parse(e):e;if(t&&"quill-table-content"===t.type)return t.html.replace(/<table[^>]*>/g,"\n[Table Start]\n").replace(/<\/table>/g,"\n[Table End]\n").replace(/<tr[^>]*>/g,"").replace(/<\/tr>/g,"\n").replace(/<td[^>]*>/g,"| ").replace(/<\/td>/g," ").replace(/<p[^>]*>/g,"").replace(/<\/p>/g,"").replace(/<br\/?>/g,"\n").replace(/<[^>]+>/g,"").replace(/\n{3,}/g,"\n\n").trim()}catch(e){}return e},s.makeHTMLValidForExternalEmbed=function(e,t){if(console.log("[DEBUG] makeHTMLValidForExternalEmbed input:",e),console.log("[DEBUG] Raw input length:",e.length),console.log("[DEBUG] Input newline count:",(e.match(/\n/g)||[]).length),!e)return console.log("[DEBUG] makeHTMLValidForExternalEmbed: empty input"),"";let n=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n{3,}/g,"\n\n").trim();console.log("[DEBUG] After newline normalization:",n),console.log("[DEBUG] Normalized newline count:",(n.match(/\n/g)||[]).length);const r=o.t.new("div");if(n=n.replace(new RegExp("<span[^>]*".concat(s.CARET_POSITION_CLASS,"[^>]*>"),"g"),""),console.log("[DEBUG] After caret removal:",n),!n.includes("<p>")){console.log("[DEBUG] Converting newlines to paragraphs");let e=n.split(/\n\s*\n/).filter(e=>e.trim());console.log("[DEBUG] Paragraph count after split:",e.length),n=(n="<p>"+e.join("</p><p>")+"</p>").replace(/\n/g,"<br>"),console.log("[DEBUG] After paragraph conversion:",n)}r.innerHTML=n,console.log("[DEBUG] Container HTML after initial set:",r.innerHTML),console.log("[DEBUG] Paragraph elements count:",r.querySelectorAll("p").length),console.log("[DEBUG] BR elements count:",r.querySelectorAll("br").length),r.querySelectorAll("table").forEach((e,t)=>{console.log("[DEBUG] Processing table ".concat(t+1)),e.setAttribute("style","border-collapse: collapse !important; width: 100% !important; border: 1px solid black !important; margin-bottom: 10px !important;"),e.className=e.className.replace(/dotexpander-table/g,"")+" dotexpander-table";const n=e.querySelectorAll("td, th");console.log("[DEBUG] Table ".concat(t+1," cell count:"),n.length)});const i=r.querySelectorAll("p");let l=0;i.forEach(e=>{e.innerHTML;e.innerHTML=e.innerHTML.replace(/\s+/g," ").trim(),e.innerHTML&&"<br>"!==e.innerHTML&&"&nbsp;"!==e.innerHTML||(e.remove(),l++)}),console.log("[DEBUG] Removed empty paragraphs count:",l);let a=r.innerHTML.replace(/>\s+</g,"><").replace(/\s+/g," ").trim();return console.log("[DEBUG] Final HTML length:",a.length),console.log("[DEBUG] Final paragraph count:",(a.match(/<p>/g)||[]).length),console.log("[DEBUG] Final BR count:",(a.match(/<br>/g)||[]).length),console.log("[DEBUG] Final processed HTML:",a),a}},,function(e,t,n){"use strict";n.d(t,"b",function(){return h}),n.d(t,"j",function(){return b}),n.d(t,"h",function(){return y}),n.d(t,"g",function(){return E}),n.d(t,"i",function(){return p}),n.d(t,"f",function(){return a}),n.d(t,"c",function(){return d}),n.d(t,"d",function(){return u}),n.d(t,"e",function(){return c}),n.d(t,"a",function(){return m});n(0);var o=n(1),r=n(5);const i=e=>{if(e===o.c.FOLDER_TYPE||e===o.c.SNIP_TYPE)return e;return{r:o.c.FOLDER_TYPE,o:o.c.SNIP_TYPE,a:o.c.FOLDER_TYPE,i:o.c.SNIP_TYPE,folder:o.c.FOLDER_TYPE,snip:o.c.SNIP_TYPE}[e]||e};function l(e){var t;if(console.log("[SERIALIZE_SNIPPET_DATA] Input:",{type:null==e?void 0:e.type,name:null==e?void 0:e.name,listLength:null==e||null===(t=e.list)||void 0===t?void 0:t.length,isInstance:e instanceof o.b}),!e)return null;const n=i(e.type),r={type:n,name:e.name,timestamp:e.timestamp};var s;n===o.c.FOLDER_TYPE?r.list=null===(s=e.list)||void 0===s?void 0:s.map(e=>l(e)).filter(Boolean):n===o.c.SNIP_TYPE&&(r.body=e.body);return r}function s(e){var t;if(console.log("[DESERIALIZE_SNIPPET_DATA] Input:",{type:null==e?void 0:e.type,name:null==e?void 0:e.name,listLength:null==e||null===(t=e.list)||void 0===t?void 0:t.length,isPlainObject:(null==e?void 0:e.constructor)===Object}),!e)return null;const n=i(e.type);if(n===o.c.FOLDER_TYPE){const t=new o.b(e.name,[],e.timestamp);return e.list&&Array.isArray(e.list)&&(t.list=e.list.map(e=>s(e)).filter(Boolean)),t}return n===o.c.SNIP_TYPE?new o.d(e.name,e.body||"",e.timestamp):null}const a={snippets:o.b.getDefaultSnippetData(),blockedSites:[],charsToAutoInsertUserList:[["(",")"],["{","}"],['"','"'],["[","]"]],dataVersion:1,language:"English",hotKey:["shiftKey","Tab"],dataUpdateVariable:!0,matchDelimitedWord:!0,tabKey:!1,snipNameDelimiterList:" @#$%&*+-=(){}[]:\"'/_<>?!.,",omniboxSearchURL:"https://www.google.com/search?q=SEARCH",wrapSelectionAutoInsert:!0,ctxEnabled:!0,dotPhrasesEnabled:!0,darkMode:!1},c="UserSnippets",d="prokeys_revisions",u="pkStorageType";function p(e){let t=JSON.parse(localStorage[d]);const n={label:"".concat(Object(r.d)()," - ").concat(window.latestRevisionLabel),data:e||Data.snippets};t.unshift(n),t=t.slice(0,20);let o=!0;for(;o;)try{localStorage[d]=JSON.stringify(t),o=!1}catch(e){o=!0,t.pop()}}const g=window.location.href&&/chrome-extension:\/\//.test(window.location.href);function h(e){console.log("[CDH] Requesting data from service worker");try{chrome.runtime.sendMessage({giveData:!0},async t=>{if(console.log("[CDH] Received raw data:",t),t.error)throw console.error("[CDH] Error getting data:",t.error),new Error(t.error);t.snippets&&(console.log("[CDH] Deserializing snippets"),t.snippets=s(t.snippets),console.log("[CDH] Deserialized snippets:",t.snippets),console.log("[CDH] snippets instanceof Folder:",t.snippets instanceof o.b)),e&&e(t)})}catch(e){throw console.error("[CDH] Error in DBget:",e),e}}function f(e){console.log("[CDH] Updating data:",Data),console.log("[CDH] Data.snippets instanceof Folder:",Data.snippets instanceof o.b);try{Data.snippets&&(console.log("[CDH] Ensuring proper instances before update"),Data.snippets=ensureProperInstances(Data.snippets),console.log("[CDH] Prepared snippets:",Data.snippets),console.log("[CDH] snippets instanceof Folder:",Data.snippets instanceof o.b));const t={...Data,snippets:l(Data.snippets)};chrome.runtime.sendMessage({updateData:t},t=>{if(console.log("[CDH] Update response:",t),t.error)throw console.error("[CDH] Error updating data:",t.error),new Error(t.error);e&&e(t)})}catch(e){throw console.error("[CDH] Error in DBupdate:",e),e}}async function m(e){var t,n;console.log("[DB_SAVE] Starting save with data:",{hasData:!!Data,hasSnippets:!(null===(t=Data)||void 0===t||!t.snippets),isSnippetsFolder:(null===(n=Data)||void 0===n?void 0:n.snippets)instanceof o.b});try{if(!Data||!Data.snippets)throw new Error("Invalid data structure");o.b.makeListIfFolder(Data),Data.dataUpdateVariable=!Data.dataUpdateVariable;const t=await chrome.runtime.sendMessage({type:"updateStorage",data:{key:c,value:Data}});if(console.log("[DB_SAVE] Storage update response:",t),null!=t&&t.success){if(o.b.makeFolderIfList(Data),e)try{e()}catch(e){console.error("[DB_SAVE] Callback error:",e)}}else console.error("[DB_SAVE] Failed to update storage:",null==t?void 0:t.error)}catch(e){console.error("[DB_SAVE] Error during save:",e),o.b.makeFolderIfList(Data)}}function b(e,t,n){console.log("[SAVE_SNIPPET_DATA] Starting save:",{hasCallback:!!e,folderNameToList:t,objectNamesToHighlight:n});try{!Data.snippets||Data.snippets instanceof o.b||(console.log("[SAVE_SNIPPET_DATA] Converting data to proper instances"),Data.snippets=ensureProperInstances(Data.snippets)),m(()=>{try{g?(console.log("[SAVE_SNIPPET_DATA] Updating UI in options page"),chrome.runtime.sendMessage({getData:!0},t=>{console.log("[SAVE_SNIPPET_DATA] Got fresh data:",{hasData:!!t,hasSnippets:!(null==t||!t.snippets)}),null!=t&&t.snippets?(Data=t,Data.snippets=s(t.snippets),window.$containerSnippets?(window.$containerSnippets.html(""),Data.snippets&&"function"==typeof Data.snippets.listSnippets?Data.snippets.listSnippets(n):console.error("[SAVE_SNIPPET_DATA] Data.snippets is not properly initialized")):console.warn("[SAVE_SNIPPET_DATA] Container not found"),Data.snippets instanceof o.b&&o.b.setIndices(Data.snippets)):console.error("[SAVE_SNIPPET_DATA] No snippets in response:",t),e&&e()})):e&&e()}catch(e){if(console.error("[SAVE_SNIPPET_DATA] Error in save callback:",e),g&&window.$containerSnippets&&Data.snippets)try{Data.snippets.listSnippets()}catch(e){console.error("[SAVE_SNIPPET_DATA] Failed to recover UI:",e)}}})}catch(e){console.error("[SAVE_SNIPPET_DATA] Error during save:",e)}}function y(e="Saved!",t){f(()=>{"function"==typeof e?e():"string"==typeof e&&window.alert(e),t&&t()})}function E(e,t){const n=Data.snippets.toArray();Data.snippets=!1,f(()=>{chrome.runtime.sendMessage({changeStorageType:!0,overridingSync:e},o=>{if(!1===o.completed)return Data.snippets=n,void f(()=>{t(!1)});e?(Data.snippets=n,f(()=>t(!0))):t&&t(!0)})})}},function(e,t,n){"use strict";n.d(t,"a",function(){return s}),n.d(t,"b",function(){return l});var o=n(0);const r={};function i(e,t,n){n.Array.prototype[e]=n.NodeList.prototype[e]=n.HTMLCollection.prototype[e]=function(...e){for(let n=0,o=this.length;n<o;n++)t.apply(this[n],e);return this},n.Node.prototype[e]=t}function l(e){for(const[t,n]of Object.entries(r))i(t,n,e);e[o.c]=!0}function s(e,t){r[e]=t}},function(e,t,n){"use strict";n.d(t,"c",function(){return l}),n.d(t,"e",function(){return a}),n.d(t,"f",function(){return s}),n.d(t,"d",function(){return p}),n.d(t,"b",function(){return i}),n.d(t,"a",function(){return g});const o=["January","February","March","April","May","June","July","August","September","October","November","December"],r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],i=864e5;function l(){const e=new Date,t=Number.padNumber(e.getHours()),n=Number.padNumber(e.getMinutes()),o=Number.padNumber(e.getSeconds());return"".concat(t,":").concat(n,":").concat(o)}function s(e){return e%4==0&&e%100!=0||e%400==0}function a(e){const t=new Date,n=Math.abs(e),o=e<0,r=o?1:-1;let i=0,l=t.getMonth(),a=t.getFullYear(),c=0;for(;c<=n;){switch((l+=r)>11?(l=0,a++):l<0&&(l=11,a--),l){case 0:case 2:case 4:case 6:case 7:case 9:case 11:i++;break;case 1:i--,s(a)||i--}c++}return o?-i:i}function c(e){return 0===e?[12,"am"]:12===e?[12,"pm"]:e>=1&&e<12?[e,"am"]:[e-12,"pm"]}function d(e,t){return"full"===t?r[e]:r[e].slice(0,3)}function u(e,t){return"full"===t?o[e]:o[e].slice(0,3)}function p(e){return(e?new Date(e):new Date).toString().substring(4,15)}const g=[["s([+-]\\d+)?",[function(e){return Number.padNumber(e.getSeconds())},1e3]],["\\bm([+-]\\d+)?\\b",[function(e){return Number.padNumber(e.getMinutes())},6e4]],["hh([+-]\\d+)?",[function(e){return Number.padNumber(e.getHours())},36e5]],["h([+-]\\d+)?",[function(e){return Number.padNumber(c(e.getHours())[0])},36e5]],["\\ba\\b",[function(e){return c(e.getHours())[1]},i]],["Do([+-]\\d+)?",[function(e){return function(e){const t=e%10;let n="th";return 1===t&&11!==e?n="st":2===t&&12!==e?n="nd":3===t&&13!==e&&(n="rd"),e+n}(e.getDate())},i]],["D([+-]\\d+)?",[function(e){return Number.padNumber(e.getDate())},i]],["dddd([+-]\\d+)?",[function(e){return d(e.getDay(),"full")},i]],["ddd([+-]\\d+)?",[function(e){return d(e.getDay(),"half")},i]],["MMMM([+-]\\d+)?",[function(e){return u(e.getMonth(),"full")},30*i]],["MMM([+-]\\d+)?",[function(e){return u(e.getMonth(),"half")},30*i]],["MM([+-]\\d+)?",[function(e){return Number.padNumber(e.getMonth()+1)},30*i]],["YYYY([+-]\\d+)?",[function(e){return e.getFullYear()},365*i]],["YY([+-]\\d+)?",[function(e){return e.getFullYear()%100},365*i]],["ZZ",[function(e){return e.toString().match(/\((.*)\)/)[1]},0]],["Z",[function(e){return e.toString().match(/\((.*)\)/)[1].split(" ").reduce((e,t)=>e+t[0],"")},0]],["z",[function(e){return e.toString().match(/GMT(.*?) /)[1]},0]],["J",[function(e){return e.getDayOfYear()},0]],["date",[p,0]],["time",[l,0]]]},function(e,t,n){"use strict";n.d(t,"a",function(){return o}),n.d(t,"b",function(){return r}),n.d(t,"e",function(){return i}),n.d(t,"c",function(){return l}),n.d(t,"d",function(){return s});const o={ENABLED:!1,OBJECT_NAME_LIMIT:50},r={SHOW_CLASS:"show",PRIMITIVES_EXT_KEY:"primitivesExtended"},i={BLOCKED_PATTERNS:[/^chrome-extension:/,/^chrome:/,/^https?:\/\/chrome\.google\.com/,/^about:blank/,/^www\./i]},l={MODIFIER_KEYS:["Control","Alt","Shift","Meta"],SPECIAL_KEYS:{ENTER:13,ESC:27,SPACE:32,TAB:9}},s={ANIMATION_DURATION:300,DEFAULT_DEBOUNCE_DELAY:250}},function(e,t,n){"use strict";n.d(t,"d",function(){return a}),n.d(t,"b",function(){return s}),n.d(t,"c",function(){return l}),n.d(t,"a",function(){return r});var o=n(0);function r(e,t){return function(n){let o=t;n.Q("li").forEach(n=>{o+="".concat(e,"<li>").concat(n.innerHTML,"</li>").concat(t)}),n.innerHTML=o}}const i=r("","");function l(e){return s(e,"innerText")}function s(e,t){if(e){if(Object(o.r)(e))return e.textContent.replace(/\u00a0/g," ");switch(e.tagName){case"TEXTAREA":case"INPUT":return e.value;default:return e[t||"innerHTML"]}}}function a(e,t,n,r){if(t=t.toString(),Object(o.r)(e))return e.textContent=t.replace(/ /g," "),e;switch(e.tagName){case"TEXTAREA":case"INPUT":e.value=t.replace("<br>","\n").replace("&nbsp;"," ");break;default:if("innerText"===n)e.innerText=t.replace("<br>","\n").replace("&nbsp;"," ");else try{e.innerHTML=t.replace(/ $/g,"&nbsp;").replace(/ {2}/g," &nbsp;"),r?function(e){const t=e.childNodes.filter(e=>Object(o.r)(e)),n=t.length;let r,l,s,a,c,d,u,p=0;for(;p<n;p++){for(s=0,a=(l=(r=t[p]).textContent.split(/\n/g)).length;s<a;s++)u=l[s],c=document.createTextNode(u),d=o.t.new("br"),e.insertBefore(d,r),e.insertBefore(c,d);e.removeChild(d),e.removeChild(r)}e.Q("pre, blockquote, ol, ul").forEach(e=>{const t=e.nextElementSibling;t&&"BR"===t.tagName&&t.parentNode.removeChild(t)}),e.Q("ol, ul").forEach(i)}(e):e.innerHTML=e.innerHTML.replace(/\n/g,"<br>")}catch(e){console.log("From setHTML: `node` argment is undefined")}}return e}},,function(e,t,n){"use strict";n.r(t),n.d(t,"Placeholder",function(){return o}),n.d(t,"testPlaceholderPresence",function(){return i}),n.d(t,"updatePlaceholderState",function(){return s}),n.d(t,"resetPlaceholderState",function(){return r}),n.d(t,"insertSnippetInContentEditableNode",function(){return c}),n.d(t,"prepareSnippetBody",function(){return a}),n.d(t,"handlePlainTextTabNavigation",function(){return d}),n.d(t,"handleRichTextTabNavigation",function(){return u}),n.d(t,"navigateToNextPlaceholder",function(){return p});let o={mode:!1,fromIndex:-1,toIndex:-1,selectionLength:0,justSelected:!1,node:null,isCENode:!1,array:[],currentIndex:-1};function r(){o.mode=!1,o.fromIndex=-1,o.toIndex=-1,o.selectionLength=0,o.justSelected=!1,o.node=null,o.isCENode=!1,o.array=[],o.currentIndex=-1}function i(e,t,n){console.log("Testing for placeholders:",{nodeType:e.nodeType,nodeName:e.nodeName,isContentEditable:e.isContentEditable,classes:e.className,content:t,startPosition:n}),window.Placeholder||(window.Placeholder={}),window.resetPlaceholderState(),window.Placeholder.node=e,window.Placeholder.isCENode=e.isContentEditable,window.Placeholder.fromIndex=n,window.Placeholder.mode=!1,window.Placeholder.array=[],window.Placeholder.currentIndex=-1,window.Placeholder.justSelected=!1;let o=e;if(e.isContentEditable){o=function(e){for(;e&&(!e.isContentEditable||null!==(t=e.parentElement)&&void 0!==t&&t.isContentEditable);){var t;e=e.parentElement}return e}(e),console.log("Root contenteditable node:",o);const n=l(t);console.log("Found placeholders in new content:",n);const r=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1);let i,s="";for(;i=r.nextNode();)s+=i.textContent;console.log("Full content from TreeWalker:",s);const a=l(s);console.log("Found all placeholders:",a);const c=[];if(n&&n.length>0&&c.push(...n),a&&a.forEach(e=>{null!=n&&n.includes(e)||c.push(e)}),console.log("Combined placeholders with priority:",c),0===c.length)return void console.log("No placeholders found");window.Placeholder.mode=!0,window.Placeholder.array=c,window.Placeholder.currentIndex=0;const d=c[0];console.log("First placeholder to select:",d),console.log("Looking for text node with placeholder in root:",o);const u=function(e,t){console.log("findTextNodeWithContent called with:",{nodeType:e.nodeType,nodeName:e.nodeName,searchText:t,nodeContent:3===e.nodeType?e.textContent:e.innerHTML});let n=e;for(;n&&(!n.isContentEditable||null!==(o=n.parentElement)&&void 0!==o&&o.isContentEditable);){var o;n=n.parentElement}if(!n)return console.error("Could not find root contenteditable container"),null;console.log("Found root contenteditable:",n),n.normalize();const r=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1);let i;for(;i=r.nextNode();)if(console.log("Checking text node:",{content:i.textContent,includes:i.textContent.includes(t)}),i.textContent.includes(t)){const e=i.textContent.indexOf(t);return console.log("Found placeholder in text node:",{node:i,text:i.textContent,placeholderIndex:e,placeholderText:t}),{node:i,start:e,end:e+t.length}}return console.log("No text node found containing:",t),null}(o,d);console.log("Found result:",u),u?(console.log("Setting range:",{node:u.node,start:u.start,end:u.end,text:u.node.textContent.substring(u.start,u.end)}),setTimeout(()=>{try{const e=window.getSelection(),t=document.createRange();t.setStart(u.node,u.start),t.setEnd(u.node,u.end),console.log("Range set, current selection:",{range:t.toString(),startOffset:t.startOffset,endOffset:t.endOffset,collapsed:t.collapsed}),e.removeAllRanges(),e.addRange(t),console.log("Selection updated:",{selectedText:e.toString(),rangeCount:e.rangeCount,type:e.type}),window.Placeholder.justSelected=!0,u.node.parentElement.scrollIntoView({behavior:"smooth",block:"center"}),console.log("Scrolled placeholder into view"),o.focus()}catch(e){console.error("Error in delayed selection:",e)}},0)):console.error("Text node for first placeholder not found")}else{const n=l(t);if(console.log("Found placeholders:",n),!n||0===n.length)return void console.log("No placeholders found");window.Placeholder.mode=!0,window.Placeholder.array=n,window.Placeholder.currentIndex=0;const o=n[0],r=t.indexOf(o);if(-1!==r){if(e.setSelectionRange(r,r+o.length),window.Placeholder.justSelected=!0,e.focus(),e.scrollHeight>e.clientHeight){const n=parseInt(window.getComputedStyle(e).lineHeight),o=t.substr(0,r).split("\n").length-1;e.scrollTop=o*n}}else console.error("First placeholder not found in content")}}function l(e,t=null){const n=/(%[^%\s]+%|\*\*)/g;if(!t){const t=[];let o;for(;null!==(o=n.exec(e));)t.push({text:o[0],index:o.index});return console.log("Found placeholders:",t),t.map(e=>e.text)}const o=[],r=document.createTreeWalker(t,NodeFilter.SHOW_TEXT);let i,l=0,s=0;for(;i=r.nextNode();){const e=i.textContent;let t;const r=new RegExp(n);for(;null!==(t=r.exec(e));)o.push({text:t[0],position:l+t.index,node:i,nodeOffset:t.index,id:s++});l+=e.length}return o.sort((e,t)=>e.position-t.position),console.log("Found placeholders in visual order:",o),window.Placeholder.positions=o,o.map(e=>e.text)}function s(e){if(!o.isCENode&&o.mode){const t=o.node.selectionStart;t>=o.fromIndex&&t<=o.toIndex&&(o.justSelected&&(o.justSelected=!1,e-=o.selectionLength),o.toIndex+=e)}}function a(e){"object"==typeof e&&e.body&&(e=e.body);try{const t=JSON.parse(e);if("quill-table-content"===t.type&&t.html){const e=document.createElement("div");e.innerHTML=t.html.trim();const n=e.querySelector("table");if(n){return n.removeAttribute("data-table"),n.removeAttribute("class"),n.style.cssText="border-collapse: collapse; width: 100%; margin: 10px 0; border: 1px solid #ccc;",n.querySelectorAll("td, th").forEach(e=>{e.removeAttribute("data-row"),e.removeAttribute("data-cell"),e.removeAttribute("class"),e.style.cssText="border: 1px solid #ccc; padding: 8px; text-align: left;";const t=e.querySelector(".ql-editor");t&&(e.innerHTML=t.innerHTML),e.querySelectorAll("*").forEach(e=>{e.className&&e.className.includes("ql-")&&e.removeAttribute("class")})}),n.outerHTML}return"<p>Error: Could not process table</p>"}if(t.ops){const e=t.ops.filter(e=>!e.insert||"string"!=typeof e.insert||""!==e.insert.trim());return t.ops=e,JSON.stringify(t)}return JSON.stringify(t)}catch(t){return console.log("Not a JSON snippet, treating as regular text"),"<div>"+String(e).replace(/[<>&]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;"})[e]).split("\n").join("<br>")+"</div>"}}function c(e,t){if(!e||!t)return console.error("Invalid parameters for insertSnippetInContentEditableNode:",{node:e,snip:t}),!1;try{const n=(e.ownerDocument.defaultView||e.ownerDocument.parentWindow).getSelection().getRangeAt(0),o=t.body;return console.log("Raw content before processing:",o),new Snip(t.name,t.body,t.timestamp).formatMacros(o=>{let r=o;console.log("Content after macro processing:",r);try{const e=JSON.parse(r);if("quill-table-content"===e.type&&e.html){let t=e.html.trim();t.includes("style=")||(t=t.replace("<table",'<table style="border-collapse: collapse; width: 100%;"')),t.includes("td style=")||(t=t.replace(/<td/g,'<td style="border: 1px solid #ccc; padding: 8px;"')),t.includes("th style=")||(t=t.replace(/<th/g,'<th style="border: 1px solid #ccc; padding: 8px; background-color: #f2f2f2;"')),r=t}}catch(e){r.includes("<")||(r=r.replace(/\n/g,"<br>"))}if(n.collapsed||n.deleteContents(),t.name){const e=n.startContainer.textContent.lastIndexOf(t.name);if(-1!==e){const o=document.createRange();o.setStart(n.startContainer,e),o.setEnd(n.startContainer,e+t.name.length),o.deleteContents()}}const l=n.startContainer,s=n.startOffset,a=document.createElement("div");a.innerHTML=r;const c=document.createDocumentFragment();for(;a.firstChild;)c.appendChild(a.firstChild);n.insertNode(c);const d=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.compareDocumentPosition(l)&Node.DOCUMENT_POSITION_PRECEDING?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let u,p="";for(;u=d.nextNode();)p+=u.textContent;console.log("New content for placeholder detection:",p),i(e,p,s);const g=new InputEvent("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(g)}),!0}catch(e){return console.error("Error in insertSnippetInContentEditableNode:",e),!1}}function d(e,t){if(console.log("Handling plain text tab navigation:",{nextPlaceholder:t,nodeType:e.nodeName,value:e.value,selectionStart:e.selectionStart,selectionEnd:e.selectionEnd}),!e||!t)return void console.error("Invalid node or placeholder");const n=e.value,r=e.selectionStart,i=n.indexOf(t,r),l=-1===i?n.indexOf(t):i;if(-1!==l){if(console.log("Found placeholder at position:",l),e.setSelectionRange(l,l+t.length),o.justSelected=!0,e.focus(),e.scrollHeight>e.clientHeight){const t=parseInt(window.getComputedStyle(e).lineHeight),o=n.substr(0,l).split("\n").length-1;e.scrollTop=o*t}}else console.error("Placeholder not found in text")}function u(e){if(console.log("Handling rich text tab navigation:",{placeholder:e}),window.Placeholder&&window.Placeholder.node)try{const e=window.getSelection(),n=document.createRange();let o=window.Placeholder.node;for(;o&&(!o.isContentEditable||null!==(t=o.parentElement)&&void 0!==t&&t.isContentEditable);){var t;o=o.parentElement}if(!o)return void console.error("Could not find root contenteditable container");console.log("Found root node for tab navigation:",o);const r=l("",o);console.log("Current remaining placeholders:",r);const i=window.Placeholder.positions||[];if(0===i.length)return console.log("No more placeholders to navigate to"),void(window.Placeholder.mode=!1);let s=-1;const a=e.toString();if(a){let t=0;const n=document.createTreeWalker(o,NodeFilter.SHOW_TEXT);let r;for(;(r=n.nextNode())&&r!==e.anchorNode;)t+=r.textContent.length;r===e.anchorNode&&(t+=e.anchorOffset);for(let e=0;e<i.length;e++){const n=i[e];if(n.text===a&&Math.abs(n.position-t)<a.length){s=e;break}}}const c=(s+1)%i.length,d=i[c];console.log("Navigation:",{currentSelection:a,currentPosition:s,nextPosition:c,nextPlaceholder:d}),d?(n.setStart(d.node,d.nodeOffset),n.setEnd(d.node,d.nodeOffset+d.text.length),e.removeAllRanges(),e.addRange(n),window.Placeholder.justSelected=!0,window.Placeholder.currentIndex=c,d.node.parentElement.scrollIntoView({behavior:"smooth",block:"center"}),o.focus()):console.error("Next placeholder position not found")}catch(e){console.error("Error in rich text tab navigation:",e)}else console.error("No placeholder node available")}function p(e){if(!o.mode||!o.array.length)return!1;const t=(o.currentIndex+1)%o.array.length;o.currentIndex=t;const n=o.array[t];return o.isCENode?u(n):d(e,n),!0}Object.assign(window,{Placeholder:o,testPlaceholderPresence:i,updatePlaceholderState:s,resetPlaceholderState:r,insertSnippetInContentEditableNode:c,prepareSnippetBody:a,handlePlainTextTabNavigation:d,handleRichTextTabNavigation:u,navigateToNextPlaceholder:p})},,function(e,t,n){"use strict";n.d(t,"a",function(){return s});var o=n(0),r=n(4),i=n(7),l=n(5);function s(){Date.prototype.isLeapYear=function(){const e=this.getFullYear();return Object(l.f)(e)},Date.prototype.getDayOfYear=function(){const e=this.getMonth(),t=this.getDate();let n=[0,31,59,90,120,151,181,212,243,273,304,334][e]+t;return e>1&&this.isLeapYear()&&n++,n},NodeList.prototype.__proto__=Array.prototype,Number.padNumber=function(e){return((e=parseInt(e,10))<=9?"0":"")+e},String.prototype.unsubstring=function(e,t){return this.substring(0,e)+this.substring(t)},Object(r.a)("trigger",function(e,t){const n=new CustomEvent(e,{detail:t||null});this.dispatchEvent(n)}),Object(r.a)("triggerKeypress",function(e){const t=new Event("input");t.keyCode=e,this.dispatchEvent(t)}),Object(r.a)("on",window.on=function(e,t,n){const o=e.split(/,\s*/g);for(const e of o)this.addEventListener(e,t,n);return this}),Object(r.a)("insertAfter",function(e){return this.parentNode.insertBefore(e,this.nextSibling),this}),Object(r.a)("hasClass",function(e){return this.className&&new RegExp("(^|\\s)".concat(e,"(\\s|$)")).test(this.className)}),Object(r.a)("toggleClass",function(e){return this.classList.toggle(e),this}),Object(r.a)("addClass",function(e){return Array.isArray(e)||(e=[e]),e.forEach(e=>{this.classList.add(e)}),this}),Object(r.a)("removeClass",function(e){return Array.isArray(e)||(e=[e]),e.forEach(e=>{this.classList.remove(e)}),this}),Object(r.a)("isTextBox",function(){return"INPUT"===this.tagName||"TEXTAREA"===this.tagName}),Object(r.a)("attr",function(e,t){return void 0!==t?(this.setAttribute(e,t),this):this.getAttribute(e)}),Object(r.a)("parent",function(e){let t=this.parentElement;for(;t;){if(t.matches(e))return t;t=t.parentElement}return null}),Object(r.a)("html",function(e,t,n){return void 0!==e?Object(i.d)(this,e,t,n):Object(i.b)(this,t)}),Object(r.a)("text",function(e){return this.html(e,"innerText")});for(const[e,t]of Object.entries(o.a))Object(r.a)(e,t)}},,,function(e,t,n){"use strict";n.r(t);var o=n(0),r=n(1),i=n(3),l=n(11),s=n(4);n(7);function a(e){const t=o.t.new("div").html(e.modal).firstChild,{action:n}=e,r="Block"===n,l=t.qClsSingle("site-name"),s=r?function(e){e=e.split("/");const[t,n]=e;return n?"Remember that you have to remove the /".concat(n," part of the URL above to block the entire ").concat(t," site."):""}(e.url):"";!function(e,t){function n(e){return function(t){13===t.keyCode&&e.call(this,t)}}let r;const l=e.qClsSingle("block-dialog-message"),s=e.qCls("block-dialog-button"),[a,c]=s,d=e.q(".block-dialog-form input"),u=e.qClsSingle("site-name"),p=e.qClsSingle("block-dialog-buttons");function g(){const e="".concat(t?"":"un","blocked"),i=function(){window.location.reload()},s=n(i),d=o.t.new("BUTTON").html("Reload page").on("click",i).on("keyup",s);l.text("URL ".concat(r," has been ").concat(e,". Reload page for changes to take effect.")),p.removeChild(a),c.html("Close dialog box"),d.classList.add("block-dialog-button-primary","block-dialog-button"),d.style.marginRight="10px",p.insertBefore(d,c),d.focus()}function h(){e.parentNode.removeChild(e)}function f(){if(r=u.value,t)Data.blockedSites.push(r),Object(i.h)(g);else{const e=Data.blockedSites.indexOf(r);if(-1!==e)Data.blockedSites.splice(e,1),Object(i.h)(g);else{const e=new RegExp(r.replace(/\/.*$/gi,""),"gi"),t=Data.blockedSites.filter(t=>e.test(t));let n="URL ".concat(r," is already unblocked. Please see the Settings page for list of blocked sites.");t.length>0&&(n+=" Or maybe you meant a blocked site from one of the following: ".concat(t.join(", "))),alert(n)}}}const m=n(h),b=n(f);a.on("click",f).on("keyup",b),c.on("click",h).on("keyup",m),d.on("keyup",b)}(t,r),t.qClsSingle("action").html(n),l.html(e.url),""!==s&&t.qClsSingle("block-dialog-message").appendChild(o.t.new("P").html(s)),window.document.body.appendChild(t),l.focus()}var c=n(5);function d(e){return e.replace(/ /g," ")}function u(e,t,n){const o=document.createTextNode(t);return n?(e.startContainer.insertBefore(o,e.startContainer.childNodes[e.startOffset]),e.setStart(o,0)):(e.endContainer.insertBefore(o,e.endContainer.childNodes[e.endOffset]),e.setEnd(o,0)),o}function p(e,t,n=!0,r){let i,l;n?Object(o.r)(e.startContainer)?(i=e.startContainer,l=e.startOffset):(i=u(e,"",!0),l=0):Object(o.r)(e.endContainer)?(i=e.endContainer,l=e.endOffset+(e.startContainer===e.endContainer)):(i=u(e,"",!1),l=0),function(e,t,n,o=!1){const r=e.textContent.substr(0,n),i=e.textContent.substr(n),l=["endContainer","endOffset","startContainer","startOffset"],s={};if(o)for(const e of l)s[e]=o[e];e.textContent=r+t+i,o&&(o.setStart(s.startContainer,s.startOffset),o.setEnd(s.endContainer,s.endOffset))}(i,t,l,e),n?e.setStart(i,l+r):e.setEnd(i,l+r)}function g(e,t,n){const r=Object(o.m)(e).getSelection(),i=r.getRangeAt(0),l=i.collapsed;let s,a;t=d(t),n?(s=t+(n=d(n)),a=1):(s=t,a=t.length),l||!l&&!Data.wrapSelectionAutoInsert?(i.deleteContents(),p(i,s,!0,a)):(!function(e){Object(o.r)(e.startContainer)&&function(e,t,n){const o=t.textContent;for(;/\s/.test(o[n])&&n<o.length;)n++;e.setStart(t,n)}(e,e.startContainer,e.startOffset),Object(o.r)(e.endContainer)&&function(e,t,n){const o=t.textContent;for(;/\s/.test(o[n-1])&&n>=1;)n--;e.setEnd(t,n)}(e,e.endContainer,e.endOffset)}(i),p(i,t,!0,t.length),n&&p(i,n,!1,0)),function(e,t){e.removeAllRanges(),e.addRange(t)}(r,i),Object(o.x)(i.startContainer),Object(o.x)(i.endContainer)}let h=null,f=null,m=-1,b=[],y=[],E=!1,S=0;const w={shiftKey:!1,ctrlKey:!1,altKey:!1,metaKey:!1,keySequence:[],lastKeyPressed:null};function C(e){h=e}function T(){return h}function D(e){f=e}function x(){return f}function v(e){m=e}function P(e){E=e}function N(){return S}function A(e){console.log("State Manager - updateModifierState:",{type:e.type,key:e.key,currentStates:{...w},eventModifiers:{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey}}),w.shiftKey=e.shiftKey,w.ctrlKey=e.ctrlKey,w.altKey=e.altKey,w.metaKey=e.metaKey,"keydown"===e.type?(w.keySequence.includes(e.key)||w.keySequence.push(e.key),w.keySequence.length>2&&w.keySequence.shift(),w.lastKeyPressed=e.key):"keyup"===e.type&&(w.keySequence=w.keySequence.filter(t=>t!==e.key),e.key===w.lastKeyPressed&&(w.lastKeyPressed=null)),console.log("State Manager - After update:",{states:{...w},sequence:[...w.keySequence]})}function O(){return{...w}}function I(){w.shiftKey=!1,w.ctrlKey=!1,w.altKey=!1,w.metaKey=!1,w.keySequence=[],w.lastKeyPressed=null}function L(e){if("keydown"!==e.type)return console.log("Not a keydown event"),!1;var t;if(!window.Data||!window.Data.hotKey||!Array.isArray(window.Data.hotKey))return console.log("No hotkey configured:",null===(t=window.Data)||void 0===t?void 0:t.hotKey),!1;const[n,o]=window.Data.hotKey,r="Tab"===e.key?"Tab":" "===e.key?"Space":e.key,i=" "===o?"Space":"Tab"===o?"Tab":o,l=n.toLowerCase().endsWith("key")?n.charAt(0).toLowerCase()+n.slice(1):n.charAt(0).toLowerCase()+n.slice(1)+"Key";console.log("Checking hotkey:",{pressedKey:r,normalizedConfigKey:i,modifierKey:n,modifierPropName:l,modifierStates:w,event:{key:e.key,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey}});if(["Shift","Control","Alt","Meta"].includes(r))return console.log("Modifier key pressed, ignoring"),!1;const s=r===i,a=!0===e[l];return s&&a}function M(){h=null,f=null,m=-1,b=[],y=[],E=!1,S=0,I(),window.modifierSequence&&(window.modifierSequence=[]),window.hotkeyActive=!1,window.lastHotkeyTime=0}function k(e,t,n){if(13===t&&("TEXTAREA"===e.target.nodeName||"INPUT"===e.target.nodeName))return!1;if(13===t&&e.target.isContentEditable&&(!window.isDotMode||!window.Data.dotPhrasesEnabled))return!1;if(!(32!==t||window.isDotMode&&window.Data.dotPhrasesEnabled))return!1;const o=O();return(32===t||13===t||9===t)&&function(e){return!(e.ctrlKey||e.altKey||e.metaKey)}(e)&&!o.shiftKey&&!L(e)}function _(e){if(!e||!e.tagName)return!1;const t=e.tagName.toLowerCase(),n=(e.type||"").toLowerCase(),o=["text","search","tel","url","email"];if(e.dataset&&"false"===e.dataset.prokeysUsable)return!1;if("input"===t){const t=o.includes(n);return e.dataset&&(e.dataset.prokeysUsable=t.toString()),t}return"textarea"===t||e.isContentEditable?(e.dataset&&(e.dataset.prokeysUsable="true"),!0):(e.dataset&&(e.dataset.prokeysUsable="false"),!1)}function R(e,t){if(e&&"number"==typeof t)if(e.isContentEditable){const e=window.getSelection(),n=e.getRangeAt(0),o=n.startContainer;if(o.nodeType===Node.TEXT_NODE){const r=Math.min(Math.max(0,n.startOffset+t),o.length);n.setStart(o,r),n.setEnd(o,r),e.removeAllRanges(),e.addRange(n)}}else{const n=Math.min(Math.max(0,e.selectionStart+t),e.value.length);e.selectionStart=e.selectionEnd=n}}let F=!1,U="",B=[],j=null,q=-1,H=null,G=null;function K(e){H=e}function Y(e){G=e}function $(e){var t;if(console.log("updateSuggestions called. isDotMode:",F,"dotPhrasesEnabled:",Data.dotPhrasesEnabled),!F||!Data.dotPhrasesEnabled)return void V();q=0,B=[],console.log("Searching for matches with buffer:",U),console.log("Available snippets:",Data.snippets);const n=(null===(t=Data)||void 0===t||null===(t=t.snippets)||void 0===t?void 0:t.list)||[];if(!n)return console.log("No snippets found"),void V();const o=e=>{Array.isArray(e)?e.forEach(e=>{if(!e)return;let t;Array.isArray(e)?e.length<=2?t=new r.d(e[0],e[1]||"",e[1]):o(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&Array.isArray(e.list)?o(e.list):t=e),t&&t.name&&t.name.toLowerCase().includes(U.toLowerCase())&&(console.log("Found matching snippet:",t),B.push(t))}):console.log("Items is not an array:",e)};o(n),console.log("Found",B.length,"matching suggestions"),B.sort((e,t)=>{const n=e.name.toLowerCase(),o=t.name.toLowerCase(),r=e.shortcut?e.shortcut.toLowerCase():"",i=t.shortcut?t.shortcut.toLowerCase():"",l=U.toLowerCase(),s=e=>e===l?0:e.startsWith(l)?1:e.includes(l)?2:3;return Math.min(s(n),s(r))-Math.min(s(o),s(i))}),function(){if(!j){(j=document.createElement("div")).className="prokeys-suggestions",j.style.maxWidth="600px",j.style.minWidth="400px",j.style.visibility="hidden",j.style.opacity="0",j.style.transition="opacity 0.15s ease-in";const e=document.createElement("style");e.textContent="\n            .prokeys-suggestions {\n                position: fixed;\n                z-index: 999999;\n                background: white;\n                border: 1px solid #ccc;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                max-height: 300px;\n                overflow-y: auto;\n                padding: 5px 0;\n            }\n            .prokeys-suggestion-item {\n                padding: 5px 10px;\n                cursor: pointer;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                gap: 20px;\n            }\n            .prokeys-suggestion-item:hover {\n                background-color: #f0f0f0;\n            }\n            .prokeys-suggestion-item.selected {\n                background-color: #e0e0e0;\n            }\n            .prokeys-suggestion-name {\n                font-weight: bold;\n            }\n            .prokeys-suggestion-description {\n                color: #666;\n                font-size: 0.9em;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n        ",document.head.appendChild(e),document.body.appendChild(j)}}();const i=function t(n=0){const o=function(e){if(!e)return{left:0,top:0};if("TEXTAREA"===e.tagName||"INPUT"===e.tagName){const t=e.getBoundingClientRect(),n=window.getComputedStyle(e),o=parseInt(n.lineHeight),r=parseInt(n.paddingTop),i=parseInt(n.paddingLeft);let l={left:t.left+i,top:t.top+r};if("TEXTAREA"===e.tagName){const t=e.value.substr(0,e.selectionStart).split("\n");l.top+=(t.length-1)*o}return l}const t=window.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0).getBoundingClientRect();return{left:e.left,top:e.top}}return{left:0,top:0}}(e);if(console.log("Got caret coordinates:",o),0===o.left&&0===o.top&&n<3)return console.log("Invalid position, retrying..."),setTimeout(()=>{const e=t(n+1);j&&0!==e.left&&0!==e.top&&(j.style.left=e.left+"px",j.style.top=e.top+20+"px",j.style.visibility="visible",setTimeout(()=>{j.style.opacity="1"},10))},50*Math.pow(2,n)),o;if(0===o.left&&0===o.top){console.log("Falling back to selection-based positioning");const t=window.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0).getBoundingClientRect();if(0!==e.left||0!==e.top)return{left:e.left+window.scrollX,top:e.top+window.scrollY}}const n=e.getBoundingClientRect();return{left:n.left+window.scrollX,top:n.top+window.scrollY}}return o}();if(B.length>0){const t=e=>e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"",n=e=>{if(!e)return"";const n=r.d.getPreviewText(e);return t(n.substring(0,50))},o=B.map((e,o)=>'\n            <div class="prokeys-suggestion-item" data-index="'.concat(o,'">\n                <span class="prokeys-suggestion-name">').concat(t(e.name),'</span>\n                <span class="prokeys-suggestion-description">').concat(n(e.body),"</span>\n            </div>\n        ")).join("");j.innerHTML=o;const l=j.getElementsByClassName("prokeys-suggestion-item");l.length>0&&l[0].classList.add("selected");const s=window.innerHeight,a=window.innerWidth;let c=i.left,d=i.top+20;const u=j.getBoundingClientRect();if(c+u.width>a&&(c=Math.max(0,a-u.width)),d+u.height>s){const e=i.top;e>s-i.top&&e>=u.height&&(d=i.top-u.height)}j.style.left=c+"px",j.style.top=d+"px",j.classList.add("show"),0===c&&20===d||(j.style.visibility="visible",setTimeout(()=>{j.style.opacity="1"},10)),j.querySelectorAll(".prokeys-suggestion-item").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const o=parseInt(t.dataset.index);if(console.log("Suggestion clicked, index:",o),!isNaN(o)&&o>=0&&o<B.length){const t=window.getOriginalNode(),n=window.getOriginalRange();if(q=o,t&&n){const e=window.getSelection();e.removeAllRanges(),e.addRange(n.cloneRange())}W(0,t||e)}})})}else V()}function V(){j&&j.parentNode&&(j.style.opacity="0",j.style.visibility="hidden",setTimeout(()=>{j&&j.parentNode&&(j.parentNode.removeChild(j),j=null)},150)),q=-1,B=[]}function W(e,t){if(console.log("Selecting suggestion, direction:",e,"currentIndex:",q),!B.length)return console.log("No suggestions available"),!1;if(0!==e){q=((q=-1===q?0:q)+e+B.length)%B.length;const t=j.getElementsByClassName("prokeys-suggestion-item");Array.from(t).forEach(e=>{e.classList.remove("selected")}),t[q]&&t[q].classList.add("selected");const n=t[q];if(n){const e=j.getBoundingClientRect(),t=n.getBoundingClientRect();t.bottom>e.bottom?n.scrollIntoView(!1):t.top<e.top&&n.scrollIntoView(!0)}return!0}const n=B[-1===q?0:q];if(!n)return console.log("No suggestion selected"),!1;try{console.log("Found suggestion:",n);const e=window.getOriginalNode(),i=window.getOriginalRange();if(e&&i){const e=window.getSelection();e.removeAllRanges(),e.addRange(i.cloneRange())}const l=e||t;if(!l)return console.error("No target node available"),!1;let s=l;for(;s&&(!s.isContentEditable||null!==(o=s.parentElement)&&void 0!==o&&o.isContentEditable);){var o;s=s.parentElement}if(l.isContentEditable)try{console.log("ContentEditable dotphrase handling - suggestion:",n);const e=window.getSelection(),t=(window.getOriginalRange()?window.getOriginalRange().cloneRange():e.getRangeAt(0),"."+J());if(console.log("Text to delete:",t),window.isGmail)for(let e=0;e<t.length;e++)document.execCommand("delete",!1);else{const e=window.getSelection();if(e.rangeCount>0){const n=e.getRangeAt(0),o=n.startContainer,r=n.startOffset,i=document.createRange();if(o.nodeType===Node.TEXT_NODE)i.setStart(o,Math.max(0,r-t.length)),i.setEnd(o,r);else{const e=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1);let n;for(;e.nextNode();)n=e.currentNode;if(n){const e=n.textContent.length;i.setStart(n,Math.max(0,e-t.length)),i.setEnd(n,e)}}i.deleteContents()}}const o=new r.d(n.name,n.body,n.timestamp);if(console.log("Created snippet:",o),!window.insertSnippetInContentEditableNode)throw console.error("insertSnippetInContentEditableNode not found"),new Error("insertSnippetInContentEditableNode not found");return window.insertSnippetInContentEditableNode(s,o),setTimeout(()=>{s&&s.focus()},0),V(),z(!1),X(""),K(null),Y(null),!0}catch(e){return console.error("Error in ContentEditable suggestion handling:",e),!1}else{const e=l.selectionStart-J().length-1,t=l.selectionStart,o=l.value.substring(0,e),r=l.value.substring(t);if(!window.insertSnippet)throw console.error("insertSnippet not found"),new Error("insertSnippet not found");l.value=o+r,l.selectionStart=l.selectionEnd=e,window.insertSnippet(l,n)}return z(!1),X(""),V(),!0}catch(e){return console.error("Error inserting suggestion:",e),!1}}function X(e){U=e}function z(e){F=e,e||V()}function Q(){return F}function J(){return U}Object.assign(window,{setOriginalNode:K,setOriginalRange:Y,getOriginalNode:function(){return H},getOriginalRange:function(){return G}});var Z=n(9);function ee(e,t,n){const o=e.substring(t,n),r=o.indexOf("=");if(-1===r)return{text:e,caretPosition:n};const i=function(e){try{if(e=e.replace(/\s/g,""),!/^[0-9+\-*/.()]+$/.test(e))return null;let t=0;for(let n of e)if("("===n&&t++,")"===n&&t--,t<0)return null;if(0!==t)return null;if(/[+\-*/.]{2,}/.test(e)||/^[*/.)]/.test(e)||/[+\-*/.(]$/.test(e))return null;const n=Function('"use strict";return ('+e+")")();return isNaN(n)||!isFinite(n)?null:n.toString()}catch(e){return console.error("Error evaluating expression:",e),null}}(o.substring(r+1));return null===i?{text:e,caretPosition:n}:{text:e.substring(0,t+r+1)+i+e.substring(n),caretPosition:t+r+1+i.length}}function te(e,t){const n=t.getSelection();if(!n.rangeCount)return!1;const o=n.getRangeAt(0),r=o.startContainer;if(!r||3!==r.nodeType)return!1;const i=r.textContent,l=o.startOffset;let s=l-1,a=0;for(;s>=0&&a<2;)"["===i[s]&&a++,s--;if(2!==a)return!1;s+=2;let c=l;for(a=0;c<i.length&&a<2;)"]"===i[c]&&a++,c++;if(2!==a)return!1;const d=ee(i,s,c-=2);return d.text!==i&&(r.textContent=d.text,o.setStart(r,d.caretPosition),o.setEnd(r,d.caretPosition),n.removeAllRanges(),n.addRange(o),!0)}function ne(e){const t=e.match(/\S+$/);if(!t)return{found:!1};const n=t[0];return function(e,t){let n=!1,o=null;const i=e=>{e.forEach(e=>{Array.isArray(e)?e.length<=2&&e[0]===t?(o=new r.d(e[0],e[1]||"",e[1]),n=!0):e.length>2&&i(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&e.list?i(e.list):e.name===t&&(o=new r.d(e.name,e.body,e.timestamp),n=!0))})};return i(e),{found:n,matchingSnip:o}}(Array.isArray(Data.snippets)?Data.snippets.slice(2):Data.snippets.list,n)}function oe(e,t){const n=function(e,t=null){if(e.isContentEditable){if(!t){const e=window.getSelection();if(!e.rangeCount)return"";t=e.getRangeAt(0)}const n=e.textContent,o=t.startOffset;return n.substring(Math.max(0,o-50),o)}{const t=e.selectionStart;return e.value.substring(Math.max(0,t-50),t)}}(e);let o;return(o=e.isContentEditable?function(e,t){const n=(e.ownerDocument.defaultView||e.ownerDocument.parentWindow).getSelection();if(!n.rangeCount)return!1;const o=n.getRangeAt(0);let r=o.startContainer;for(;r&&!r.isContentEditable;)r=r.parentNode;if(!r)return!1;const{found:i,matchingSnip:l}=ne(t);return!(!i||!l||(o.setStart(o.startContainer,o.startOffset-l.name.length),o.deleteContents(),window.insertSnippetInContentEditableNode(r,l),0))}(e,n):function(e,t){const{found:n,matchingSnip:o}=ne(t);if(!n||!o)return!1;const r=e.selectionStart,i=r-o.name.length,l=e.value.substring(0,i),s=e.value.substring(r);return e.value=l+s,e.selectionStart=e.selectionEnd=i,window.insertSnippet(e,o),!0}(e,n))&&(window.resetModifierStates(),window.resetAllState(),function(){window.resetModifierSequence&&window.resetModifierSequence();window.clearHotkeyFlags&&window.clearHotkeyFlags()}()),o}var re=n(6);Object(l.a)(),console.log("ProKeys detector.js starting"),function(e){if(void 0===e)return void console.error("Window is not defined");e.location.pathname.includes("options.html");console.log("ProKeys IIFE starting");const t="prokeys_content_script",n="prokeys_is_iframe",l=1e3;let d,u,p,h=!1;function f(t){console.log("afterDBget called with response:",t),t&&t.snippets?(e.Data=t,Data=t,console.log("Data object initialized:",e.Data),console.log("dotPhrasesEnabled:",e.Data.dotPhrasesEnabled),console.log("snippets:",e.Data.snippets),m()):console.error("Invalid DataResponse:",t)}function m(){if(console.log("setPageDOM called"),e.top!==e)return;if(e.IN_OPTIONS_PAGE)return;const t=e;let n=!1;e.Data&&e.Data.blockedSites&&(n=Object(o.n)(e.location.href))&&a(),K(t,n),U(document),Object(o.j)("done initializing"),e.isGmail=/mail\.google/.test(e.location.href)}let w=setInterval(()=>{e&&e.document?(console.log("Checking window load state:",e.document.readyState),"complete"===e.document.readyState&&(console.log("Window load complete, calling onPageLoad"),clearInterval(w),console.log("onPageLoad called"),e.IN_OPTIONS_PAGE?(console.log("In options page, setting timeout"),setTimeout(m,1e3)):(console.log("Not in options page, getting DB"),Object(i.b)(f)))):console.log("Window or document not ready yet")},100);function F(r){let i,a;try{if(i=r.contentDocument,a=r.contentWindow,!i||!a)return;if(!i[t]){i[t]=!0,i[n]=!0,Object(s.b)(a),K(a);const o=e.isGmail?500:l;setInterval(U,o,i)}}catch(e){e.message.includes("cross-origin")||Object(o.j)(e,r,i,a)}}function U(e){if(!e)return;const t=e.getElementsByTagName("iframe");for(let e=0;e<t.length;e++){const n=t[e];try{n.contentDocument&&F(n)}catch(e){}}e.querySelectorAll("*").forEach(function e(t){t.shadowRoot&&(t.shadowRoot.querySelectorAll("iframe").forEach(e=>{try{e.contentDocument&&F(e)}catch(e){}}),t.shadowRoot.querySelectorAll("*").forEach(e))})}function B(t,n=null,o=null,i=!1){if(console.log("Checking for snippet, dotPhrase:",n,"isHotkey:",i,"node:",t),!Q()&&null===n&&!i)return console.log("Not in dot mode, no dotPhrase provided, and not hotkey triggered, skipping snippet check"),null;let l,s,a,d,u=null,p=!1;if(t.isContentEditable){const g=(t.ownerDocument.defaultView||t.ownerDocument.parentWindow).getSelection();if(!(d=o||(g.rangeCount?g.getRangeAt(0):null)))return console.log("No valid range found"),null;let h=d.startContainer;for(;h&&!h.isContentEditable;)h=h.parentNode;if(!h)return console.log("No contenteditable container found"),null;if(t=h,l=d.startOffset,s=d.endOffset,a=d.startContainer.textContent,n)try{console.log("Searching for dotPhrase:",n);const o=Array.isArray(Data.snippets)?Data.snippets.slice(2):Data.snippets.list;if(!o)return console.log("No snippets list found"),!1;const i=e=>{e.forEach(e=>{Array.isArray(e)?e.length<=2&&e[0]===n?(p=!0,u=new r.d(e[0],e[1]||"",e[1])):e.length>2&&i(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&e.list?i(e.list):e.name===n&&(p=!0,u=new r.d(e.name,e.body||"",e.timestamp||Object(c.c)())))})};if(i(o),p&&u){console.log("Found snippet for dot phrase:",u.name);const o=e.getSelection().getRangeAt(0);return o.setStart(o.startContainer,o.startOffset-n.length-1),o.deleteContents(),X(""),V(),C(null),D(null),v(-1),q(t,u),!0}return!1}catch(e){return console.error("Error searching for snippet:",e),!1}if(i){const n=Math.min(l,50),o=a.substring(l-n,l);console.log("Looking for snippet in text:",o);for(let e=1;e<=o.length;e++){let t=o.substring(o.length-e),n=!1,i=null;const l=e=>(e.forEach(e=>{Array.isArray(e)?e.length<=2&&e[0]===t?(i=new r.d(e[0],e[1]||"",Object(c.c)()),n=!0):e.length>2&&l(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&e.list?l(e.list):e.name===t&&(i=new r.d(e.name,e.body||"",e.timestamp||Object(c.c)()),n=!0))}),i),s=Array.isArray(Data.snippets)?Data.snippets.slice(2):Data.snippets.list,a=l(s);if(n&&a){u=a,console.log("Found snippet:",u);break}}if(u){console.log("Found snippet to insert:",u);const n=e.getSelection().getRangeAt(0);return n.setStart(n.startContainer,n.startOffset-u.name.length),n.deleteContents(),q(t,u),!0}return console.log("No matching snippet found"),!1}return!1}{if(l=t.selectionStart,s=t.selectionEnd,a=t.value,n)try{console.log("Searching for dotPhrase:",n),console.log("Data.snippets:",Data.snippets);const o=Array.isArray(Data.snippets)?Data.snippets.slice(2):Data.snippets.list;if(!o)return console.log("No snippets list found"),!1;const i=e=>{e.forEach(e=>{let t;Array.isArray(e)?e.length<=2?t={name:e[0],body:e[1]||"",timestamp:e[1]}:i(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&e.list?i(e.list):"folder"!==e.type&&(t=e)),t&&(t.name&&t.name.toLowerCase()===n.toLowerCase()||t.shortcut&&t.shortcut.toLowerCase()===n.toLowerCase())&&(console.log("Found matching snippet:",t),p=!0,u=t)})};if(i(o),p&&u){if(console.log("Found snippet for dot phrase:",u.name),u=new r.d(u.name,u.body||"",u.timestamp),"TEXTAREA"===t.nodeName||"INPUT"===t.nodeName){const e=t.selectionStart-n.length-1,o=t.selectionStart;t.setSelectionRange(e,o),document.execCommand("delete",!1)}else{const t=e.getSelection().getRangeAt(0);t.setStart(t.startContainer,t.startOffset-n.length-1),t.deleteContents()}return X(""),V(),C(null),D(null),v(-1),t.isContentEditable?q(t,u):j(t,u),!0}return console.log("No snippet found for dot phrase:",n),!1}catch(e){return console.error("Error searching for snippet:",e),!1}if(l!==s)return!1;const o=Array.isArray(Data.snippets)?Data.snippets.slice(2):Data.snippets.list;if(!o)return console.log("No snippets list found"),!1;let i=Math.min(l,50),c=a.substring(l-i,l),d=null;for(let e=1;e<=c.length;e++){let t=c.substring(c.length-e),n=!1;const i=e=>{e.forEach(e=>{Array.isArray(e)?e.length<=2&&e[0]===t?(d=new r.d(e[0],e[1]||"",e[1]),n=!0):e.length>2&&i(e.slice(2)):e&&"object"==typeof e&&("folder"===e.type&&e.list?i(e.list):e.name===t&&(d=new r.d(e.name,e.body,e.timestamp),n=!0))})};if(i(o),n){u=d;break}}return null!==u&&(setTimeout(()=>{const e=a.substring(0,l-u.name.length),n=a.substring(l);u.formatMacros(o=>{o=r.d.makeHTMLSuitableForTextareaThroughString(o),t.isContentEditable?t.innerHTML=e+o+n:t.value=e+o+n,setTimeout(()=>{t.normalize();const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let n,o="";for(;n=e.nextNode();)o+=n.textContent;console.log("Actual text content after macro processing:",o),Object(Z.testPlaceholderPresence)(t,o,l-u.name.length)},0)})},10),!0)}}function j(e,t){console.log("Inserting snippet into plain text editor:",t);const n=e.selectionStart;new r.d(t.name,t.body,t.timestamp).formatMacros(t=>{t=r.d.makeHTMLSuitableForTextareaThroughString(t);const o=e.value.substring(0,n),i=e.value.substring(n);e.value=o+t+i,Object(Z.testPlaceholderPresence)(e,e.value,0)})}function q(e,t){if(!e||!t)return console.error("Invalid parameters for insertSnippetInContentEditableNode:",{node:e,snip:t}),!1;try{const n=(e.ownerDocument.defaultView||e.ownerDocument.parentWindow).getSelection(),o=n.getRangeAt(0);return new r.d(t.name,t.body,t.timestamp).formatMacros(r=>{let i=r;try{const e=JSON.parse(i);if("quill-table-content"===e.type&&e.html){let t=e.html.trim();console.log("Raw table HTML:",JSON.stringify(t)),(t=t.replace(/<temporary[^>]*>.*?<\/temporary>/g,"")).includes("style=")||(t=t.replace("<table",'<table style="border-collapse: collapse; width: 100%;"')),t.includes("td style=")||(t=t.replace(/<td/g,'<td style="border: 1px solid #ccc; padding: 8px;"')),t.includes("th style=")||(t=t.replace(/<th/g,'<th style="border: 1px solid #ccc; padding: 8px; background-color: #f2f2f2;"')),i=t=(t=t.replace(/^(?:\s*<br\s*\/?>\s*)+(<table)/i,"$1")).replace(/(<\/table>)(?:\s*<p>\s*<br\s*\/?>\s*<\/p>\s*)+$/i,"$1"),console.log("Processed table HTML:",JSON.stringify(i))}}catch(e){i.includes("<")||(i=i.replace(/\n/g,"<br>"))}if(o.collapsed||o.deleteContents(),t.name){const e=o.startContainer.textContent.lastIndexOf(t.name);if(-1!==e){const n=document.createRange();n.setStart(o.startContainer,e),n.setEnd(o.startContainer,e+t.name.length),n.deleteContents()}}const l=document.createElement("div");l.innerHTML=i.trim();const s=document.createDocumentFragment();let a=l.firstChild;for(;a;)if(a.nodeType!==Node.TEXT_NODE||a.textContent.trim())s.appendChild(a),a=l.firstChild;else{const e=a.nextSibling;l.removeChild(a),a=e}o.insertNode(s),setTimeout(()=>{e.normalize();const t=e.innerHTML;console.log("Content after insertion:",t),Object(Z.testPlaceholderPresence)(e,t,0);const o=document.createRange(),r=e.lastChild;o.setStartAfter(r),o.collapse(!0),n.removeAllRanges(),n.addRange(o)},100);const c=new InputEvent("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(c)}),!0}catch(e){return console.error("Error in insertSnippetInContentEditableNode:",e),!1}}function H(e){return function(t){const n=t.target;_(n)&&e.call(n,t)}}d=function(t){var n;const r=t.target;if(Object(o.j)("Key down event:",{key:t.key,keyCode:t.keyCode,shiftKey:t.shiftKey,target:t.target.nodeName,isContentEditable:t.target.isContentEditable,hotKey:null===(n=e.Data)||void 0===n?void 0:n.hotKey}),A(t),!_(r))return;const i=t.keyCode||t.which,l=t.key;if(O().shiftKey||O().ctrlKey||O().altKey||O().metaKey){if(L(t)){var s;if(console.log("Hotkey detected:",{event:t,modifierStates:O(),hotKey:null===(s=e.Data)||void 0===s?void 0:s.hotKey}),t.preventDefault(),t.stopPropagation(),r.isContentEditable){return B(r,null,e.getSelection().getRangeAt(0).cloneRange(),!0)}return oe(r)}}else{if("Tab"===l){var a,c;console.log("Tab key pressed, checking modes:",{placeholderMode:null===(a=e.Placeholder)||void 0===a?void 0:a.mode,dotMode:Q()});const n=function(e,t,n){return L(e)?(console.log("Tab is part of hotkey combination, not handling as special tab"),!1):((n||t)&&(e.preventDefault(),e.stopPropagation()),n?(console.log("In dot mode, handling tab"),"dotmode"):t?(console.log("In placeholder mode, handling tab"),"placeholder"):(console.log("No special tab handling needed"),!1))}(t,null===(c=e.Placeholder)||void 0===c?void 0:c.mode,Q());return n?(t.preventDefault(),t.stopPropagation(),void("placeholder"===n?(console.log("Handling placeholder tab navigation"),Object(Z.navigateToNextPlaceholder)(r)||console.log("No placeholders available")):"dotmode"===n&&(console.log("Handling dot mode tab completion"),W(0,r)?(console.log("Successfully selected suggestion"),z(!1),X(""),V()):console.log("Failed to select suggestion")))):void console.log("No special tab handling needed")}if("F2"!==l){if(i===re.c.SPECIAL_KEYS.SPACE&&e.Placeholder&&!0===e.Placeholder.mode){const n=e.getSelection().getRangeAt(0);if(!n.collapsed){const e=n.commonAncestorContainer;if(e.nodeType===Node.ELEMENT_NODE&&(e.classList.contains(PLACE_CLASS)||e.querySelector("."+PLACE_CLASS)))return void t.preventDefault()}}if(Q()&&Data.dotPhrasesEnabled&&t.keyCode===re.c.SPECIAL_KEYS.ESC){if(t.preventDefault(),z(!1),"TEXTAREA"===r.nodeName||"INPUT"===r.nodeName){const e=Math.max(0,r.selectionStart-J().length-1),t=r.selectionStart;r.setSelectionRange(e,t),document.execCommand("delete",!1)}else{const t=e.getSelection().getRangeAt(0),n=t.startContainer,o=t.startOffset,r=J().length+1,i=Math.max(0,o-r);try{if(n.nodeType===Node.TEXT_NODE)t.setStart(n,i);else{const e=[],o=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1);let i;for(;i=o.nextNode();)e.push(i);if(e.length>0){const n=e[e.length-1];t.setStart(n,Math.max(0,n.length-r))}}t.deleteContents()}catch(e){console.warn("Error setting range:",e),t.collapse(!0)}}return X(""),V(),C(null),D(null),void v(-1)}if(Q()&&Data.dotPhrasesEnabled&&8===t.keyCode)return console.log("Backspace in dot mode, current buffer:",J()),J().length>1?(X(J().slice(0,-1)),console.log("Buffer after backspace:",J()),$(r),!0):(z(!1),X(""),V(),C(null),D(null),v(-1),!0);if(Q()&&Data.dotPhrasesEnabled){if(38===i)return t.preventDefault(),t.stopPropagation(),W(-1,r),!1;if(40===i)return t.preventDefault(),t.stopPropagation(),W(1,r),!1;if(13===i)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),W(0,r),!1}if(!Q()||!Data.dotPhrasesEnabled||32!==i){if(9===i&&e.Placeholder.mode){t.preventDefault(),console.log("Tab pressed in placeholder mode");const n=(e.Placeholder.currentIndex+1)%e.Placeholder.array.length;console.log("Moving to next placeholder:",{currentIndex:e.Placeholder.currentIndex,nextIndex:n,totalPlaceholders:e.Placeholder.array.length,placeholders:e.Placeholder.array}),e.Placeholder.currentIndex=n;const o=e.Placeholder.array[n],i="string"==typeof o?o:o.text;if(e.Placeholder.isCENode){const t=function e(t){let n=[];if(3===t.nodeType)n.push(t);else{const o=t.childNodes;for(let t=0;t<o.length;t++)n=n.concat(e(o[t]))}return n}(r);for(let n of t){const t=n.textContent.indexOf(i);if(-1!==t){const o=document.createRange();o.setStart(n,t),o.setEnd(n,t+i.length);const r=e.getSelection();r.removeAllRanges(),r.addRange(o),e.Placeholder.justSelected=!0;break}}}else{placeholders[0];const t=content.indexOf(i);r.setSelectionRange(t,t+i.length),e.Placeholder.justSelected=!0}return!1}return k(t,i)?(t.preventDefault(),void B(r)):void 0}if(t.preventDefault(),""===J()){if(console.log("Space after dot, cancelling dot mode"),z(!1),X(""),v(-1),C(null),D(null),r.isContentEditable)document.execCommand("insertText",!1," ");else{const e=r.selectionStart,t=r.value;r.value=t.slice(0,e)+" ",r.selectionStart=r.selectionEnd=e+1}return void(h=!1)}W(0,r)&&(e.Placeholder.justSelected||(z(!1),X(""),v(-1),C(null),D(null)))}else{var d,u;if(console.log("F2 key pressed, checking for placeholders"),t.preventDefault(),t.stopPropagation(),null===(d=e.Placeholder)||void 0===d||!d.mode){console.log("Not in placeholder mode, checking for placeholders");const e=r.isContentEditable?r.innerHTML:r.value;Object(Z.testPlaceholderPresence)(r,e,0)}null!==(u=e.Placeholder)&&void 0!==u&&u.mode&&(console.log("Navigating to next placeholder with F2"),Object(Z.navigateToNextPlaceholder)(r)||console.log("No more placeholders available"))}}},u=function(t){console.log("handleKeyPress called",t);const n=t.target;if(console.log("Target node:",n),!_(n))return void console.log("Node not usable:",n);console.log("Node is usable");const r=String.fromCharCode(t.charCode);if(console.log("Char typed:",r),Q()&&Data.dotPhrasesEnabled)if(console.log("In dot mode, buffer:",J())," "===r||13===t.charCode){if(console.log("Space/Enter pressed in dot mode"),13===t.charCode)return!1;if(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),W(0,n))return e.Placeholder.justSelected?console.log("Placeholder selected, keeping state in keypress"):(console.log("No placeholder selected, cleaning up state in keypress"),z(!1),X(""),v(-1),C(null),D(null)),!1}else{if("."===r){if(console.log("Dot pressed, entering dot mode. dotPhrasesEnabled:",Data.dotPhrasesEnabled),Data.dotPhrasesEnabled){if(e.Placeholder&&e.Placeholder.mode&&(console.log("Exiting placeholder mode to enter dot mode"),e.Placeholder.mode=!1,e.Placeholder.currentIndex=-1),z(!0),h=!0,X(""),n.isContentEditable){const t=e.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0);D(e.cloneRange()),C(n),v(e.startOffset)}}else C(n),v(n.selectionStart);if(e.isGmail)return document.execCommand("insertText",!1,"."),t.preventDefault(),t.stopPropagation(),!1;$(n)}return}if(e.isGmail){t.preventDefault(),t.stopPropagation(),X(J()+r),document.execCommand("insertText",!1,r),$(n);const o=e.getSelection();if(o.rangeCount>0){D(o.getRangeAt(0).cloneRange())}return!1}X(J()+r),$(n)}else if("."===r){if(console.log("Dot pressed, entering dot mode. dotPhrasesEnabled:",Data.dotPhrasesEnabled),Data.dotPhrasesEnabled){if(e.Placeholder&&e.Placeholder.mode&&(console.log("Exiting placeholder mode to enter dot mode"),e.Placeholder.mode=!1,e.Placeholder.currentIndex=-1),z(!0),h=!0,X(""),n.isContentEditable){const t=e.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0);D(e.cloneRange()),C(n),v(e.startOffset)}}else C(n),v(n.selectionStart);if(e.isGmail)return document.execCommand("insertText",!1,"."),t.preventDefault(),t.stopPropagation(),!1;$(n)}return}const i={firstChar:b,secondChar:y};if(E&&i[0]&&getCharFollowingCaret(n)===r?(t.preventDefault(),R(n,1),P(!1)):i[0]&&("({".indexOf(i[0])>-1&&previousCharactersForEmoji(n)||(t.preventDefault(),function(e,t,n){if(Object(o.o)(e))g(e,t,n);else{let r=e.value,i=e.selectionStart,l=e.selectionEnd,s=r.substring(0,i),a=r.substring(i,l),c=r.substring(l),d=a.match(/^(\s*)(\S?(?:.|\n|\r)*\S)(\s*)$/)||["","","",""];s+=d[1],c=d[3]+c,a=d[2],a=Data.wrapSelectionAutoInsert?a:"",l=(i=s.length+ +!!n)+a.length,e.value=s+t+a+(n||"")+c,e.selectionStart=i,e.selectionEnd=l,Object(o.x)(e)}}(n,i[0],i[1]),P(!0))),"="===r){const e=Object(o.m)(n);setTimeout(te,10,n,e)}const l=Object(Z.updatePlaceholderState)();if(l&&!l.isCENode){const e=n.selectionStart;l.mode&&e>=l.fromIndex&&e<=l.toIndex&&(l.justSelected&&(l.justSelected=!1,s=N()-l.selectionLength,S=s),l.toIndex+=N())}var s},p=function(e){A(e)},e.insertSnippet=j;H(d),H(u),H(p);const G=new WeakMap;function K(t,n){if(G.get(t))return void console.log("Handlers already attached to window, skipping");if(console.log("Attaching handlers, isBlocked:",n),n)return void console.log("Page is blocked, not attaching key handlers");if(e.isGmail){console.log("Attaching handlers for Gmail");const e=()=>{const e=['div[contenteditable="true"][role="textbox"]','div[contenteditable="true"][aria-label*="Message"]','div[contenteditable="true"][aria-label*="Compose"]','div[g_editable="true"]'];for(const t of e){document.querySelectorAll(t).forEach(e=>{e.dataset.prokeysHandled||(console.log("Found Gmail editor:",e),e.dataset.prokeysHandled="true",e.addEventListener("keydown",e=>{A(e),d(e)}),e.addEventListener("keypress",e=>{A(e),u(e)}),e.addEventListener("keyup",e=>{A(e),p(e)}))})}};e(),new MutationObserver(()=>{e()}).observe(document.body,{childList:!0,subtree:!0})}t.document.addEventListener("keydown",function(e){A(e),d(e)},!0),t.document.addEventListener("keypress",function(e){A(e),u(e)},!0),t.document.addEventListener("keyup",function(e){A(e),p(e)},!0),t.document.addEventListener("beforeinput",t=>{const n=t.target;if(n.isContentEditable){if(L({type:"keydown",key:t.data,shiftKey:O().shiftKey,ctrlKey:O().ctrlKey,altKey:O().altKey,metaKey:O().metaKey,preventDefault:()=>t.preventDefault(),stopPropagation:()=>t.stopPropagation()})){t.preventDefault();const o=e.getSelection();if(o.rangeCount>0){B(n,null,o.getRangeAt(0).cloneRange(),!0)}}}},!0),G.set(t,!0),console.log("Key handlers attached to document")}e.IN_OPTIONS_PAGE?console.log("In options page, not getting DB"):(console.log("Not in options page, getting DB"),Object(i.b)(f)),e.insertSnippetInContentEditableNode=q,e.resetModifierStates=I,e.resetAllState=M,e.getOriginalNode=T,e.getOriginalRange=x,function(){function t(e){const t=new KeyboardEvent("keydown",{key:e,code:"Key"+e,keyCode:"Backspace"===e?8:e.charCodeAt(0),which:"Backspace"===e?8:e.charCodeAt(0),bubbles:!0,cancelable:!0});document.dispatchEvent(t)}e.location.href.includes("docs.google.com")&&document.addEventListener("keydown",async function(e){if("Tab"===e.key&&(e.shiftKey||e.ctrlKey||e.altKey)){e.preventDefault();try{if(!document.querySelector(".kix-appview-editor"))return void console.log("Editor not found");const e=function(){try{const e=document.querySelector(".kix-cursor.docs-cursor-selectable");if(!e)return"";const t=document.querySelectorAll(".kix-lineview .kix-wordhtmlgenerator-word-node");let n="",o=!1;for(const r of t){const t=r.getBoundingClientRect(),i=e.getBoundingClientRect();Math.abs(t.top-i.top)<5&&(o||(n+=r.textContent),t.left>=i.left&&(o=!0))}return n}catch(e){return console.error("Error getting text from Google Docs:",e),""}}();if(!e)return void console.log("No text before cursor");const n=e.match(/\S+$/);if(!n)return void console.log("No word found before cursor");const o=n[0];if(console.log("Looking for snippet:",o),(await chrome.runtime.sendMessage({type:"getSnippetContent",snippetName:o})).success){for(let e=0;e<o.length;e++)t("Backspace");await new Promise(e=>setTimeout(e,50)),document.execCommand("paste")}}catch(e){console.error("Error handling snippet in Google Docs:",e)}}})}()}(window)}]);